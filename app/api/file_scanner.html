<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malware Scanner | Azure DevSecOps</title>
  <meta name="description" content="Scan files and payloads for malware, viruses, and threats using ClamAV." />
  <meta name="theme-color" content="#0b1020" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#f6f7fb" media="(prefers-color-scheme: light)" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --primary: #2563eb;
      --primary-ink: #ffffff;
      --success: #16a34a;
      --success-ink: #ffffff;
      --success-soft: rgba(22, 163, 74, 0.14);
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.14);
      --code-bg: #0b1020;
      --code-fg: #d6e0ff;
      --ring: rgba(37, 99, 235, 0.22);
      --primary-soft: rgba(37, 99, 235, 0.12);
      --primary-soft-border: rgba(37, 99, 235, 0.45);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1020;
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #22304a;
        --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
        --primary: #60a5fa;
        --primary-ink: #0b1020;
        --success: #4ade80;
        --success-ink: #0b1020;
        --success-soft: rgba(74, 222, 128, 0.16);
        --danger: #fb7185;
        --danger-soft: rgba(251, 113, 133, 0.16);
        --code-bg: #070b18;
        --code-fg: #d6e0ff;
        --ring: rgba(96, 165, 250, 0.26);
        --primary-soft: rgba(96, 165, 250, 0.14);
        --primary-soft-border: rgba(96, 165, 250, 0.45);
      }
    }

    /* Animations */
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }

      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px circle at 15% 5%, rgba(37, 99, 235, 0.16), transparent 55%),
        radial-gradient(900px circle at 85% 18%, rgba(220, 38, 38, 0.10), transparent 55%),
        var(--bg);
      color: var(--text);
      line-height: 1.45;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Skip to main content link */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 0;
      padding: 0.75rem 1.25rem;
      background: var(--primary);
      color: var(--primary-ink);
      font-weight: 700;
      z-index: 9999;
      border-radius: 0 0 10px 0;
      transition: top 0.2s ease;
    }

    .skip-link:focus {
      top: 0;
      outline: none;
      box-shadow: 0 0 0 4px var(--ring);
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: calc(1rem + env(safe-area-inset-top));
      right: calc(1rem + env(safe-area-inset-right));
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
      max-width: min(380px, calc(100vw - 2rem));
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      pointer-events: auto;
      animation: slideIn 0.25s ease forwards;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .toast.toast-out {
      animation: slideOut 0.2s ease forwards;
    }

    .toast-icon {
      flex: 0 0 auto;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 900;
    }

    .toast.toast-success .toast-icon {
      background: var(--success-soft);
      color: var(--success);
    }

    .toast.toast-error .toast-icon {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .toast.toast-info .toast-icon {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .toast.toast-warn .toast-icon {
      background: rgba(234, 179, 8, 0.14);
      color: rgba(234, 179, 8, 1);
    }

    .toast-message {
      flex: 1;
      min-width: 0;
    }

    .toast-close {
      flex: 0 0 auto;
      padding: 0.25rem;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 6px;
    }

    .toast-close:hover {
      background: rgba(148, 163, 184, 0.12);
    }

    /* Button loading state */
    button.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }

    button.loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid var(--primary-ink);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    button:not(.primary).loading::after {
      border-color: var(--text);
      border-top-color: transparent;
    }

    a {
      color: var(--primary);
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    .app {
      max-width: 1920px;
      margin: 0 auto;
      padding: clamp(1.25rem, 2vw, 2rem) clamp(1.5rem, 2vw, 3rem) 3rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header h1 {
      margin: 0;
      font-size: 1.65rem;
      letter-spacing: -0.02em;
    }

    .sub {
      margin: 0.35rem 0 0;
      color: var(--muted);
      line-height: 1.4;
    }

    .grid {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: minmax(320px, 420px) 1fr;
      gap: 1.15rem;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: linear-gradient(180deg, rgba(148, 163, 184, 0.06), rgba(148, 163, 184, 0.02)), var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 1rem;
    }

    .card.full {
      grid-column: 1 / -1;
    }

    .card h2 {
      margin: 0 0 0.75rem;
      font-size: 1.05rem;
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }

    .field {
      margin-bottom: 0.9rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }

    input,
    textarea {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(148, 163, 184, 0.06);
      color: var(--text);
      transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    textarea {
      min-height: 160px;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--muted);
      opacity: 0.75;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
      background: rgba(148, 163, 184, 0.04);
    }

    .help {
      margin-top: 0.35rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .timestamp-cell {
      font-size: 0.9rem;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      white-space: nowrap;
    }

    .sha-cell {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.2rem;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 4px;
      transition: background 100ms ease, color 100ms ease;
      font-size: 0.75rem;
    }

    .copy-btn:hover {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text);
    }

    .copy-btn.copied {
      color: var(--success-ink);
    }

    /* Eye icon for API key toggle */
    .eye-icon {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    /* API key input with toggle */
    .api-key-group {
      display: flex;
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(148, 163, 184, 0.06);
      overflow: hidden;
      transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    .api-key-group:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
      background: rgba(148, 163, 184, 0.04);
    }

    .api-key-input {
      flex: 1 1 auto;
      border: none;
      background: transparent;
      padding: 0.65rem 0.75rem;
      width: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      letter-spacing: 0.02em;
    }

    .api-key-input:focus,
    .api-key-input:focus-visible {
      outline: none;
      box-shadow: none;
      background: transparent;
    }

    .api-key-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 0.75rem;
      border: none;
      background: rgba(148, 163, 184, 0.08);
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      font-size: 1rem;
    }

    .api-key-toggle:hover {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text);
    }

    .api-key-saved {
      display: inline-flex;
      align-items: center;
      padding: 0 0.6rem;
      color: var(--success-ink);
      background: var(--success);
      font-size: 0.85rem;
    }

    .actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 0.6rem 0.85rem;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 80ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
    }

    button:hover:not(:disabled) {
      background: rgba(148, 163, 184, 0.08);
      transform: translateY(-1px);
    }

    button.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--primary-ink);
      font-weight: 600;
    }

    button.primary:hover:not(:disabled) {
      filter: brightness(1.03);
    }

    button:focus-visible,
    .tab:focus-visible,
    input:focus-visible,
    textarea:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px var(--ring);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .status {
      margin-top: 0.85rem;
      min-height: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--muted);
    }

    .badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight: 600;
    }

    .badge.ok {
      border-color: rgba(22, 163, 74, 0.5);
      background: rgba(22, 163, 74, 0.12);
    }

    .badge.warn {
      border-color: rgba(234, 179, 8, 0.6);
      background: rgba(234, 179, 8, 0.14);
    }

    .badge.bad {
      border-color: rgba(220, 38, 38, 0.5);
      background: rgba(220, 38, 38, 0.12);
    }

    .badge.info {
      border-color: var(--primary-soft-border);
      background: var(--primary-soft);
    }

    .muted {
      color: var(--muted);
    }

    .small {
      font-size: 0.85rem;
    }

    pre {
      margin: 0;
      background: var(--code-bg);
      color: var(--code-fg);
      padding: 1rem;
      border-radius: 12px;
      overflow: auto;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      line-height: 1.45;
    }

    .table-wrap {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.03);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
    }

    th,
    td {
      text-align: left;
      padding: 0.55rem 0.65rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    th {
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: var(--muted);
      background: rgba(148, 163, 184, 0.10);
      position: sticky;
      top: 0;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .nowrap {
      white-space: nowrap;
    }

    .item-cell {
      max-width: 340px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .filter {
      flex: 1;
      min-width: 220px;
    }

    .history-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex: 1;
      min-width: min(560px, 100%);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    select.select {
      width: auto;
      min-width: 170px;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(148, 163, 184, 0.06);
      color: var(--text);
      transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    select.select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
      background: rgba(148, 163, 184, 0.04);
    }

    .job-actions {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
    }

    .job-actions button {
      padding: 0.35rem 0.55rem;
      font-size: 0.82rem;
    }

    @media (max-width: 720px) {
      .table-wrap {
        border: 0;
        background: transparent;
      }

      table {
        min-width: 0;
      }

      thead {
        display: none;
      }

      tbody {
        display: block;
      }

      tr {
        display: block;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0.75rem;
        margin-bottom: 0.65rem;
        background: rgba(148, 163, 184, 0.03);
      }

      td {
        display: block;
        border-bottom: 0;
        padding: 0.35rem 0;
      }

      td[data-label] {
        display: grid;
        grid-template-columns: minmax(86px, 120px) 1fr;
        gap: 0.65rem;
        align-items: start;
      }

      td[data-label]::before {
        content: attr(data-label);
        font-size: 0.72rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 700;
        padding-top: 0.12rem;
      }

      td.nowrap {
        white-space: normal;
      }

      td[colspan] {
        text-align: center;
        padding: 0.85rem 0;
      }

      .item-cell {
        max-width: none;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      .history-controls {
        justify-content: stretch;
      }

      .history-controls .filter {
        min-width: 0;
        flex: 1 1 100%;
      }

      .history-controls .select {
        width: 100%;
        min-width: 0;
      }
    }

    .history-pager {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 0.25rem 0 0.85rem;
    }

    .tab {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .tab[aria-selected="true"] {
      background: var(--primary-soft);
      border-color: var(--primary-soft-border);
    }

    .tab[aria-current="page"] {
      background: var(--primary-soft);
      border-color: var(--primary-soft-border);
    }

    a.tab {
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }

    .panel.hidden {
      display: none;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
      align-items: start;
    }

    .summary-col {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 0;
    }

    @media (max-width: 900px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-block {
      --dot: var(--primary);
      --dot-soft: var(--primary-soft);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.95rem;
      background: rgba(148, 163, 184, 0.04);
      backdrop-filter: blur(10px);
      align-self: start;
      height: fit-content;
      min-width: 0;
    }

    .summary-block.span-all {
      grid-column: 1 / -1;
    }

    .summary-block.tone-ok {
      --dot: var(--success);
      --dot-soft: var(--success-soft);
    }

    .summary-block.tone-warn {
      --dot: rgba(234, 179, 8, 1);
      --dot-soft: rgba(234, 179, 8, 0.14);
    }

    .summary-block.tone-bad {
      --dot: var(--danger);
      --dot-soft: var(--danger-soft);
    }

    .summary-block h3 {
      margin: 0 0 0.75rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding-bottom: 0.55rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.14);
    }

    .summary-block h3::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--dot);
      box-shadow: 0 0 0 4px var(--dot-soft);
      opacity: 0.9;
      flex: 0 0 auto;
    }

    .summary-title {
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .summary-meta {
      margin-left: auto;
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      justify-content: flex-end;
    }

    dl.kv {
      display: block;
      margin: 0;
    }

    dl.kv.kv-wide .kv-row {
      grid-template-columns: 1fr;
    }

    dl.kv.kv-wide dt {
      display: none;
    }

    dl.kv .kv-row {
      display: grid;
      grid-template-columns: minmax(120px, 170px) 1fr;
      gap: 0.35rem 0.8rem;
      padding: 0.4rem 0;
    }

    dl.kv .kv-row>* {
      min-width: 0;
    }

    dl.kv .kv-row+.kv-row {
      border-top: 1px solid rgba(148, 163, 184, 0.14);
    }

    dl.kv dt {
      color: var(--muted);
      font-size: 0.72rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding-top: 0.12rem;
    }

    dl.kv dd {
      margin: 0;
      min-width: 0;
      overflow-wrap: anywhere;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      line-height: 1.35;
    }

    dl.kv dd .value-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.85rem;
      background: rgba(148, 163, 184, 0.08);
      padding: 0.15rem 0.4rem;
      border-radius: 6px;
    }

    .value-row {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      justify-content: space-between;
      width: 100%;
    }

    .value-row> :first-child {
      flex: 1 1 auto;
      min-width: 0;
    }

    .value-row .icon-btn {
      flex: 0 0 auto;
    }

    .icon-btn {
      padding: 0.3rem 0.55rem;
      border-radius: 10px;
      font-size: 0.78rem;
      line-height: 1;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(148, 163, 184, 0.08);
    }

    .icon-btn:hover:not(:disabled) {
      background: rgba(148, 163, 184, 0.14);
      transform: none;
    }

    @media (max-width: 520px) {
      dl.kv .kv-row {
        grid-template-columns: 1fr;
        gap: 0.2rem;
      }

      dl.kv dt {
        padding-top: 0;
      }

      .app {
        padding: 1rem 1rem 2rem;
      }

      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .header h1 {
        font-size: 1.45rem;
      }

      .header .actions {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
      }

      .header .actions>button,
      .header .actions>a {
        width: 100%;
      }

      .header .actions>a.tab {
        justify-content: center;
      }

      .card .actions {
        flex-direction: column;
        align-items: stretch;
      }

      .card .actions>button {
        width: 100%;
      }

      .card-head .filter {
        min-width: 0;
        flex: 1 1 100%;
      }

      .toast-container {
        top: auto;
        bottom: calc(1rem + env(safe-area-inset-bottom));
        right: auto;
        left: 50%;
        transform: translateX(-50%);
        max-width: min(520px, calc(100vw - 2rem));
      }
    }

    .value-code {
      display: inline-block;
      padding: 0.18rem 0.45rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(148, 163, 184, 0.08);
      font-size: 0.86rem;
      line-height: 1.2;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Status/verdict colors for value-code */
    .value-code.status-ok {
      background: var(--success-soft);
      border-color: rgba(22, 163, 74, 0.4);
      color: var(--success);
    }

    .value-code.status-warn {
      background: rgba(234, 179, 8, 0.14);
      border-color: rgba(234, 179, 8, 0.4);
      color: rgba(234, 179, 8, 1);
    }

    .value-code.status-bad {
      background: var(--danger-soft);
      border-color: rgba(220, 38, 38, 0.4);
      color: var(--danger);
    }

    /* Timestamp styling */
    .timestamp-value {
      font-variant-numeric: tabular-nums;
      cursor: help;
    }

    .kv-actions {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .inline-check {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      color: var(--muted);
      font-size: 0.85rem;
      user-select: none;
    }

    .inline-check input {
      width: auto;
    }
  </style>
</head>

<body>
  <!-- Skip to main content link -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Toast notification container -->
  <div id="toastContainer" class="toast-container" role="region" aria-label="Notifications" aria-live="polite"></div>

  <div class="app">
    <header class="header">
      <div>
        <h1>Malware Scanner</h1>
        <p class="sub">Scan files and payloads for malware using ClamAV. <a href="/docs">API Docs</a></p>
      </div>
      <div class="actions">
        <a class="tab" href="/">URL scanner</a>
        <a class="tab" aria-current="page" href="/file">File scanner</a>
        <button id="clearHistory" type="button">Clear history</button>
      </div>
    </header>

    <main id="main-content">
      <div class="grid">
        <section class="card" aria-labelledby="new-scan-heading">
          <h2 id="new-scan-heading">New scan</h2>
          <div class="field">
            <label for="apiKey">API key <span class="muted">(header: __API_KEY_HEADER__)</span></label>
            <div class="api-key-group">
              <input id="apiKey" class="api-key-input" type="password" autocomplete="off" placeholder="Paste API key" />
              <button id="apiKeyToggle" type="button" class="api-key-toggle" title="Show/hide API key"
                aria-label="Toggle API key visibility"><svg class="eye-icon" viewBox="0 0 24 24">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg></button>
              <span id="apiKeySaved" class="api-key-saved" style="display: none;"
                title="Saved to local storage">âœ“</span>
            </div>
            <div class="help">Saved in this browser only (local storage).</div>
          </div>

          <div class="tabs" role="tablist" aria-label="Input type">
            <button id="tabInputFile" class="tab" role="tab" aria-selected="true" aria-controls="panelInputFile"
              type="button">File</button>
            <button id="tabInputPayload" class="tab" role="tab" aria-selected="false" aria-controls="panelInputPayload"
              type="button">Payload</button>
          </div>

          <div id="panelInputFile" class="panel" role="tabpanel" aria-labelledby="tabInputFile">
            <div class="field">
              <label for="fileInput">File</label>
              <input id="fileInput" type="file" />
              <div id="fileHelp" class="help"></div>
            </div>
          </div>

          <div id="panelInputPayload" class="panel hidden" role="tabpanel" aria-labelledby="tabInputPayload">
            <div class="field">
              <label for="payload">Payload</label>
              <textarea id="payload" placeholder="Paste content to scan"></textarea>
              <div class="help">Tip: For attachments/payloads, paste the raw bytes as base64 and enable base64 decoding.
              </div>
            </div>
            <div class="field">
              <label class="inline-check">
                <input id="payloadBase64" type="checkbox" />
                Payload is base64
              </label>
            </div>
          </div>

          <div class="actions">
            <button id="start" class="primary" type="button">Scan</button>
            <button id="copyJson" type="button" disabled>Copy JSON</button>
          </div>
          <div id="status" class="status" aria-live="polite"></div>
        </section>

        <section class="card">
          <div class="card-head">
            <h2>History</h2>
            <div class="history-controls">
              <input id="historyFilter" class="filter" placeholder="Filter by filename, sha256, or verdict"
                aria-label="Filter history" />
              <select id="historyOrder" class="select" aria-label="Order history">
                <option value="recent" selected>Most recent</option>
                <option value="oldest">Oldest</option>
              </select>
            </div>
          </div>
          <div class="table-wrap" role="region" aria-label="File scan history">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">When</th>
                  <th>Item</th>
                  <th class="nowrap">SHA-256</th>
                  <th class="nowrap">Verdict</th>
                  <th class="nowrap">Actions</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
          <div class="history-pager" aria-label="History pagination">
            <button id="historyPrev" type="button">Prev</button>
            <span id="historyPageInfo" class="muted small"></span>
            <button id="historyNext" type="button">Next</button>
          </div>
          <p class="muted small">History is tied to your API key and stored server-side.</p>
        </section>

        <section class="card full" aria-labelledby="result-heading">
          <div class="card-head">
            <h2 id="result-heading">Result</h2>
            <div class="actions">
              <button id="copyJson2" type="button" disabled>Copy JSON</button>
            </div>
          </div>
          <div class="tabs" role="tablist" aria-label="Response view">
            <button id="tabSummary" class="tab" role="tab" aria-selected="true" aria-controls="panelSummary"
              type="button">Summary</button>
            <button id="tabRaw" class="tab" role="tab" aria-selected="false" aria-controls="panelRaw" type="button">Raw
              JSON</button>
          </div>
          <div id="panelSummary" class="panel" role="tabpanel" aria-labelledby="tabSummary">
            <div id="summaryOut" class="summary-grid"></div>
          </div>
          <div id="panelRaw" class="panel hidden" role="tabpanel" aria-labelledby="tabRaw">
            <pre id="out">{}</pre>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const API_KEY_HEADER = __API_KEY_HEADER_JSON__;
      const FILE_SCAN_MAX_BYTES = Number(__FILE_SCAN_MAX_BYTES__ || 0);

      const LS = {
        apiKey: 'acaScanner.apiKey',
        legacyApiKey: 'apiKey',
      };

      const apiKeyEl = document.getElementById('apiKey');
      const apiKeyToggleEl = document.getElementById('apiKeyToggle');
      const apiKeySavedEl = document.getElementById('apiKeySaved');
      const fileInputEl = document.getElementById('fileInput');
      const payloadEl = document.getElementById('payload');
      const payloadBase64El = document.getElementById('payloadBase64');
      const startEl = document.getElementById('start');
      const statusEl = document.getElementById('status');
      const outEl = document.getElementById('out');
      const summaryOutEl = document.getElementById('summaryOut');
      const copyJsonEl = document.getElementById('copyJson');
      const copyJson2El = document.getElementById('copyJson2');
      const clearHistoryEl = document.getElementById('clearHistory');
      const historyBodyEl = document.getElementById('historyBody');
      const historyFilterEl = document.getElementById('historyFilter');
      const historyOrderEl = document.getElementById('historyOrder');
      const historyPrevEl = document.getElementById('historyPrev');
      const historyNextEl = document.getElementById('historyNext');
      const historyPageInfoEl = document.getElementById('historyPageInfo');

      const HISTORY_PAGE_SIZE = 5;
      const HISTORY_FETCH_LIMIT = 500;
      let historyPage = 1;
      let historyLastRenderedAt = null;
      let historyLoading = false;
      let historyLoadError = null;
      let historyLastLoadedAt = null;
      let historyRefreshTimer = null;
      const fileHelpEl = document.getElementById('fileHelp');
      const toastContainerEl = document.getElementById('toastContainer');

      const tabInputFileEl = document.getElementById('tabInputFile');
      const tabInputPayloadEl = document.getElementById('tabInputPayload');
      const panelInputFileEl = document.getElementById('panelInputFile');
      const panelInputPayloadEl = document.getElementById('panelInputPayload');

      const tabSummaryEl = document.getElementById('tabSummary');
      const tabRawEl = document.getElementById('tabRaw');
      const panelSummaryEl = document.getElementById('panelSummary');
      const panelRawEl = document.getElementById('panelRaw');

      let activeInput = 'file'; // file | payload
      let activeTab = 'summary'; // summary | raw

      let history = [];
      let lastResult = null;

      // ===========================================
      // Toast Notification System
      // ===========================================
      const toastQueue = [];
      let toastCounter = 0;

      function showToast(message, type = 'info', duration = 4000) {
        const id = ++toastCounter;
        const icons = { success: 'âœ“', error: 'âœ•', warn: '!', info: 'i' };

        const toast = el('div', { class: 'toast toast-' + type, 'data-toast-id': String(id) },
          el('span', { class: 'toast-icon', 'aria-hidden': 'true', text: icons[type] || icons.info }),
          el('span', { class: 'toast-message', text: message }),
          el('button', { class: 'toast-close', 'aria-label': 'Dismiss', type: 'button', text: 'âœ•' })
        );

        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => dismissToast(toast));

        toastContainerEl.appendChild(toast);
        toastQueue.push({ id, toast, timer: null });

        if (duration > 0) {
          const entry = toastQueue.find(t => t.id === id);
          if (entry) {
            entry.timer = setTimeout(() => dismissToast(toast), duration);
          }
        }

        while (toastQueue.length > 5) {
          const oldest = toastQueue.shift();
          if (oldest && oldest.toast.isConnected) {
            if (oldest.timer) clearTimeout(oldest.timer);
            oldest.toast.remove();
          }
        }

        return id;
      }

      function dismissToast(toast) {
        if (!toast || !toast.isConnected) return;
        toast.classList.add('toast-out');
        setTimeout(() => {
          if (toast.isConnected) toast.remove();
          const idx = toastQueue.findIndex(t => t.toast === toast);
          if (idx >= 0) {
            if (toastQueue[idx].timer) clearTimeout(toastQueue[idx].timer);
            toastQueue.splice(idx, 1);
          }
        }, 200);
      }

      // ===========================================
      // Button Loading State Helpers
      // ===========================================
      function setButtonLoading(btn, loading) {
        if (!btn) return;
        if (loading) {
          btn.classList.add('loading');
          btn.disabled = true;
        } else {
          btn.classList.remove('loading');
        }
      }

      const dtf = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });
      const dtfFull = new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZoneName: 'short'
      });

      function formatBytes(n) {
        const v = Number(n);
        if (!Number.isFinite(v)) return '';
        if (v < 1024) return v + ' B';
        const kb = v / 1024;
        if (kb < 1024) return kb.toFixed(1) + ' KB';
        const mb = kb / 1024;
        return mb.toFixed(2) + ' MB';
      }

      function formatWhen(iso) {
        if (!iso) return '';
        try { return dtf.format(new Date(iso)); } catch (_) { return iso; }
      }

      function formatRelativeTime(iso) {
        if (!iso) return '';
        try {
          const date = new Date(iso);
          const now = Date.now();
          const diff = now - date.getTime();
          const seconds = Math.floor(diff / 1000);
          const minutes = Math.floor(seconds / 60);
          const hours = Math.floor(minutes / 60);
          const days = Math.floor(hours / 24);

          if (seconds < 60) return 'just now';
          if (minutes < 60) return minutes === 1 ? '1 min ago' : minutes + ' mins ago';
          if (hours < 24) return hours === 1 ? '1 hour ago' : hours + ' hours ago';
          if (days < 7) return days === 1 ? 'yesterday' : days + ' days ago';
          return formatWhen(iso);
        } catch (_) {
          return formatWhen(iso);
        }
      }

      // Format timestamp with timezone for summary display
      function formatTimestamp(iso) {
        if (!iso) return '';
        try { return dtfFull.format(new Date(iso)); } catch (_) { return String(iso); }
      }

      function timestampValue(isoStr) {
        if (!isoStr) return null;
        const formatted = formatTimestamp(isoStr);
        return el('span', { class: 'timestamp-value', title: String(isoStr), text: formatted });
      }

      function el(tag, attrs) {
        const node = document.createElement(tag);
        if (attrs) {
          for (const [k, v] of Object.entries(attrs)) {
            if (k === 'class') node.className = v;
            else if (k === 'text') node.textContent = v;
            else if (k === 'title') node.title = v;
            else node.setAttribute(k, v);
          }
        }
        for (let i = 2; i < arguments.length; i++) {
          const child = arguments[i];
          if (child == null) continue;
          if (typeof child === 'string') node.appendChild(document.createTextNode(child));
          else node.appendChild(child);
        }
        return node;
      }

      function makeBadge(kind, label) {
        const cls = kind ? ('badge ' + kind) : 'badge';
        return el('span', { class: cls, text: label });
      }

      function verdictKind(verdict) {
        const v = String(verdict || '').toLowerCase();
        if (v === 'clean' || v === 'benign') return 'ok';
        if (v === 'suspicious') return 'warn';
        if (v === 'malicious' || v === 'infected' || v === 'error') return 'bad';
        return 'info';
      }

      function setStatus(kind, text) {
        statusEl.textContent = '';
        if (!text) return;
        const effectiveKind = kind === 'pending' ? 'info' : (kind || 'info');
        const label = kind === 'pending'
          ? 'PENDING'
          : (kind === 'ok' ? 'OK' : (kind === 'bad' ? 'ERROR' : (kind === 'warn' ? 'WARN' : 'INFO')));
        statusEl.appendChild(makeBadge(effectiveKind, label));
        statusEl.appendChild(document.createTextNode(' ' + text));
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          showToast('Copied to clipboard', 'success', 2500);
        } catch (_) {
          const ta = el('textarea', { style: 'position:fixed;left:-1000px;top:-1000px;' });
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          showToast('Copied to clipboard', 'success', 2500);
        }
      }

      function setButtonsEnabled(hasJson) {
        copyJsonEl.disabled = !hasJson;
        copyJson2El.disabled = !hasJson;
      }

      function loadApiKey() {
        const key = (localStorage.getItem(LS.apiKey) || '').trim() || (localStorage.getItem(LS.legacyApiKey) || '').trim();
        if (key) {
          apiKeyEl.value = key;
          apiKeySavedEl.style.display = 'inline-flex';
        }
      }

      function saveApiKey() {
        const v = apiKeyEl.value.trim();
        if (v) localStorage.setItem(LS.apiKey, v);
      }

      function scheduleHistoryRefresh(ms) {
        if (historyRefreshTimer) clearTimeout(historyRefreshTimer);
        historyRefreshTimer = setTimeout(() => {
          historyPage = 1;
          refreshHistoryFromServer({ silent: true });
        }, Math.max(0, Number(ms || 0)) || 450);
      }

      async function refreshHistoryFromServer(opts) {
        const silent = opts && opts.silent;
        historyLoadError = null;

        const key = apiKeyEl.value.trim();
        if (!key) {
          historyLoading = false;
          historyLoadError = null;
          history = [];
          historyLastLoadedAt = null;
          renderHistory();
          return;
        }

        historyLoading = true;
        renderHistory();
        try {
          const res = await apiJson('/jobs?limit=' + HISTORY_FETCH_LIMIT + '&type=file', 'GET');
          const jobs = res && res.jobs;
          if (!Array.isArray(jobs)) {
            throw Object.assign(new Error('Invalid /jobs response'), { data: res });
          }
          history = jobs;
          historyLastLoadedAt = new Date().toISOString();
          if (!silent) showToast('History refreshed', 'success', 2500);
        } catch (e) {
          const msg = (e && e.data && e.data.detail)
            ? e.data.detail
            : (e && e.message ? e.message : String(e || 'Failed to load history'));
          history = [];
          historyLoadError = msg;
          if (!silent) showToast(msg, 'error', 6000);
        } finally {
          historyLoading = false;
          renderHistory();
        }
      }

      async function clearHistoryServer() {
        const key = apiKeyEl.value.trim();
        if (!key) {
          historyLoading = false;
          historyLoadError = null;
          history = [];
          renderHistory();
          return;
        }
        try {
          await apiJson('/jobs?type=file', 'DELETE');
          showToast('History cleared', 'success', 2500);
        } catch (e) {
          const msg = (e && e.data && e.data.detail)
            ? e.data.detail
            : (e && e.message ? e.message : String(e || 'Failed to clear history'));
          showToast(msg, 'error', 6000);
        } finally {
          await refreshHistoryFromServer({ silent: true });
        }
      }

      async function viewJob(jobId) {
        const id = String(jobId || '').trim();
        if (!id) return;
        try {
          const resp = await apiJson('/scan/' + encodeURIComponent(id) + '?view=full', 'GET');
          showResult(resp);
        } catch (e) {
          const msg = (e && e.data && e.data.detail)
            ? e.data.detail
            : (e && e.message ? e.message : String(e || 'Failed to load result'));
          showToast(msg, 'error', 6000);
        }
      }

      function renderHistory() {
        historyBodyEl.textContent = '';
        const q = (historyFilterEl.value || '').trim().toLowerCase();
        const order = (historyOrderEl && historyOrderEl.value) ? String(historyOrderEl.value) : 'recent';

        if (historyLoading) {
          historyPageInfoEl.textContent = 'Loadingâ€¦';
          historyBodyEl.appendChild(
            el('tr', null,
              el('td', { class: 'muted', colspan: '5', text: 'Loading historyâ€¦' })
            )
          );
          return;
        }

        if (historyLoadError) {
          historyPageInfoEl.textContent = 'Error';
          historyBodyEl.appendChild(
            el('tr', null,
              el('td', { class: 'muted', colspan: '5', text: historyLoadError })
            )
          );
          return;
        }

        const items = history.filter(x => {
          if (!q) return true;
          const hay = [
            x.filename || '',
            x.sha256 || '',
            x.verdict || '',
            x.signature || '',
          ].join(' ').toLowerCase();
          return hay.includes(q);
        });

        // Sort by most recent first
        items.sort((a, b) => {
          const aMs = Date.parse(a.submitted_at || a.scanned_at || 0);
          const bMs = Date.parse(b.submitted_at || b.scanned_at || 0);
          if (order === 'oldest') return aMs - bMs;
          return bMs - aMs;
        });

        const total = items.length;
        const totalPages = Math.max(1, Math.ceil(total / HISTORY_PAGE_SIZE));
        if (historyPage > totalPages) historyPage = totalPages;
        if (historyPage < 1) historyPage = 1;

        historyPrevEl.disabled = historyPage <= 1;
        historyNextEl.disabled = historyPage >= totalPages;

        historyLastRenderedAt = new Date();
        const updated = historyLastLoadedAt ? formatWhen(historyLastLoadedAt) : '';
        historyPageInfoEl.textContent = `Page ${historyPage}/${totalPages} Â· ${total} scan${total === 1 ? '' : 's'}${updated ? ' Â· Updated ' + updated : ''}`;

        if (!items.length) {
          historyBodyEl.appendChild(
            el('tr', null,
              el('td', { class: 'muted', colspan: '5', text: q ? 'No matching scans.' : 'No history yet.' })
            )
          );
          return;
        }

        const start = (historyPage - 1) * HISTORY_PAGE_SIZE;
        const pageItems = items.slice(start, start + HISTORY_PAGE_SIZE);

        for (const item of pageItems) {
          const verdict = String(item.verdict || '');
          const verdictBadge = makeBadge(verdictKind(verdict), verdict ? verdict.toUpperCase() : 'â€”');

          const viewBtn = el('button', { type: 'button' }, 'View');
          viewBtn.addEventListener('click', () => {
            viewJob(item.job_id);
          });

          const actions = el('div', { class: 'job-actions' }, viewBtn);

          const whenIso = item.submitted_at || item.scanned_at;
          const whenRelative = formatRelativeTime(whenIso);
          const whenTitleParts = [];
          if (item.submitted_at) whenTitleParts.push('Submitted: ' + formatWhen(item.submitted_at));
          if (item.scanned_at) whenTitleParts.push('Scanned: ' + formatWhen(item.scanned_at));
          const whenTitle = whenTitleParts.length ? whenTitleParts.join('\n') : formatWhen(whenIso);

          // SHA cell with copy button
          const sha = item.sha256 || '';
          const shortSha = sha ? (sha.slice(0, 12) + 'â€¦') : '';
          const shaCode = el('code', { text: shortSha, title: sha });
          const copyShaInlineBtn = el('button', { type: 'button', class: 'copy-btn', title: 'Copy SHA-256', 'aria-label': 'Copy SHA-256', text: 'ðŸ“‹' });
          copyShaInlineBtn.disabled = !sha;
          copyShaInlineBtn.addEventListener('click', async () => {
            if (!sha) return;
            try {
              await navigator.clipboard.writeText(sha);
              copyShaInlineBtn.textContent = 'âœ“';
              copyShaInlineBtn.classList.add('copied');
              setTimeout(() => {
                copyShaInlineBtn.textContent = 'ðŸ“‹';
                copyShaInlineBtn.classList.remove('copied');
              }, 1500);
            } catch (e) {
              showToast('Failed to copy SHA-256', 'error');
            }
          });
          const shaCell = el('span', { class: 'sha-cell' }, shaCode, sha ? copyShaInlineBtn : null);

          historyBodyEl.appendChild(
            el('tr', null,
              el('td', { class: 'timestamp-cell', 'data-label': 'When', text: whenRelative, title: whenTitle }),
              el('td', { class: 'item-cell', 'data-label': 'Item', title: item.filename || '', text: item.filename || '' }),
              el('td', { 'data-label': 'SHA-256' }, shaCell),
              el('td', { class: 'nowrap', 'data-label': 'Verdict' }, verdictBadge),
              el('td', { class: 'nowrap', 'data-label': 'Actions' }, actions)
            )
          );
        }
      }

      function kvRow(k, v) {
        const valueNode = (v instanceof Node)
          ? v
          : el('span', { class: 'value-code', text: String(v == null ? '' : v) });
        return el('div', { class: 'kv-row' },
          el('dt', { text: k }),
          el('dd', null, valueNode)
        );
      }

      function makeCopyableValue(text, displayText) {
        const val = String(text || '');
        const display = displayText || val;

        const codeEl = el('code', { class: 'value-code', text: display });

        if (!val) return codeEl;

        const copyBtn = el('button', {
          type: 'button',
          class: 'icon-btn',
          title: 'Copy',
          'aria-label': 'Copy',
          text: 'Copy'
        });

        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(val);
          } catch (e) {
            showToast('Failed to copy', 'error');
          }
        });

        return el('span', { class: 'value-row' }, codeEl, copyBtn);
      }

      function block(title, rows, opts) {
        const cls = 'summary-block' + (opts && opts.tone ? (' tone-' + opts.tone) : '') + (opts && opts.spanAll ? ' span-all' : '');
        const dl = el('dl', { class: 'kv' });
        for (const [k, v] of rows) dl.appendChild(kvRow(k, v));
        return el('section', { class: cls },
          el('h3', null, el('span', { class: 'summary-title', text: title })),
          dl
        );
      }

      function renderSummary(resp) {
        summaryOutEl.textContent = '';
        const r = resp && typeof resp === 'object' ? resp : {};
        const verdict = String(r.verdict || '');
        const hasData = Boolean(
          verdict ||
          r.signature ||
          r.submitted_at ||
          r.scanned_at ||
          r.duration_ms != null ||
          r.input_type ||
          r.filename ||
          r.size_bytes != null ||
          r.sha256 ||
          (r.clamav && typeof r.clamav === 'object' && Object.keys(r.clamav).length)
        );
        if (!hasData) {
          summaryOutEl.appendChild(el('div', { class: 'muted', text: 'No data yet.' }));
          return;
        }
        const tone = verdictKind(verdict) === 'ok' ? 'ok' : (verdictKind(verdict) === 'bad' ? 'bad' : 'info');

        const verdictRows = [
          ['Verdict', makeBadge(verdictKind(verdict), verdict ? verdict.toUpperCase() : 'UNKNOWN')],
        ];
        if (r.signature) verdictRows.push(['Signature', String(r.signature)]);
        if (r.submitted_at) verdictRows.push(['Submitted', timestampValue(r.submitted_at)]);
        if (r.scanned_at) verdictRows.push(['Scanned', timestampValue(r.scanned_at)]);
        if (r.duration_ms != null) verdictRows.push(['Scan time', String(r.duration_ms) + ' ms']);
        summaryOutEl.appendChild(block('Verdict', verdictRows, { tone }));

        const fileRows = [
          ['Type', String(r.input_type || '')],
          ['Name', String(r.filename || '')],
          ['Size', formatBytes(r.size_bytes)],
          ['SHA-256', makeCopyableValue(r.sha256)],
        ];
        summaryOutEl.appendChild(block('Artifact', fileRows, { tone: 'info' }));

        const clam = (r.clamav && typeof r.clamav === 'object') ? r.clamav : {};
        const engineRows = [
          ['Host', String(clam.host || '') + (clam.port ? (':' + clam.port) : '')],
        ];
        if (clam.version) engineRows.push(['Version', String(clam.version)]);
        if (clam.response) engineRows.push(['Response', String(clam.response)]);
        if (clam.error) engineRows.push(['Error', String(clam.error)]);
        summaryOutEl.appendChild(block('ClamAV', engineRows, { tone: tone === 'bad' ? 'bad' : 'info' }));
      }

      function renderRaw(resp) {
        outEl.textContent = JSON.stringify(resp || {}, null, 2);
      }

      function normalizeFileResult(obj) {
        if (!obj || typeof obj !== 'object') return {};

        // If this is a generic /scan/{job_id} response, flatten the stored file-scan details.
        if (obj.details && typeof obj.details === 'object') {
          const d = obj.details;
          const merged = Object.assign({}, d);

          if (obj.job_id && !merged.job_id) merged.job_id = obj.job_id;
          if (obj.job_id && !merged.scan_id) merged.scan_id = obj.job_id;
          if (obj.status && !merged.status) merged.status = obj.status;
          if (obj.submitted_at && !merged.submitted_at) merged.submitted_at = obj.submitted_at;
          if (obj.scanned_at && !merged.scanned_at) merged.scanned_at = obj.scanned_at;
          if (obj.size_bytes != null && merged.size_bytes == null) merged.size_bytes = obj.size_bytes;
          if (obj.duration_ms != null && merged.duration_ms == null) merged.duration_ms = obj.duration_ms;
          if (obj.verdict && !merged.verdict) merged.verdict = obj.verdict;
          if (obj.error && !merged.error) merged.error = obj.error;

          return merged;
        }

        return obj;
      }

      function showResult(obj) {
        lastResult = normalizeFileResult(obj);
        renderSummary(lastResult);
        if (activeTab === 'raw') renderRaw(lastResult);
        const verdict = lastResult && typeof lastResult === 'object' ? String(lastResult.verdict || '').toLowerCase() : '';
        setButtonsEnabled(Boolean(lastResult) && verdict !== 'pending');
      }

      function setActiveTab(next) {
        activeTab = next;
        const isSummary = next === 'summary';
        tabSummaryEl.setAttribute('aria-selected', isSummary ? 'true' : 'false');
        tabRawEl.setAttribute('aria-selected', isSummary ? 'false' : 'true');
        panelSummaryEl.classList.toggle('hidden', !isSummary);
        panelRawEl.classList.toggle('hidden', isSummary);
        if (!isSummary) renderRaw(lastResult || {});
        else renderSummary(lastResult || {});
      }

      function setActiveInput(next) {
        activeInput = next;
        const isFile = next === 'file';
        tabInputFileEl.setAttribute('aria-selected', isFile ? 'true' : 'false');
        tabInputPayloadEl.setAttribute('aria-selected', isFile ? 'false' : 'true');
        panelInputFileEl.classList.toggle('hidden', !isFile);
        panelInputPayloadEl.classList.toggle('hidden', isFile);
      }

      async function apiJson(path, method) {
        const headers = { accept: 'application/json' };
        const key = apiKeyEl.value.trim();
        if (key) headers[API_KEY_HEADER] = key;
        const res = await fetch(path, { method: method || 'GET', headers });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
        if (!res.ok) {
          const err = new Error('HTTP ' + res.status);
          err.status = res.status;
          err.data = data;
          throw err;
        }
        return data;
      }

      async function apiForm(path, formData) {
        const headers = {};
        const key = apiKeyEl.value.trim();
        if (key) headers[API_KEY_HEADER] = key;
        const res = await fetch(path, { method: 'POST', headers, body: formData });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
        if (!res.ok) {
          const err = new Error('HTTP ' + res.status);
          err.status = res.status;
          err.data = data;
          throw err;
        }
        return data;
      }

      async function startScan() {
        saveApiKey();
        setStatus('pending', 'Analyzingâ€¦');
        setButtonLoading(startEl, true);
        setButtonsEnabled(false);
        lastResult = null;
        renderSummary(null);
        if (activeTab === 'raw') renderRaw({});

        const startedAt = new Date().toISOString();
        const inputType = activeInput;
        let label = '';

        try {
          const fd = new FormData();
          if (inputType === 'file') {
            const f = fileInputEl.files && fileInputEl.files[0];
            if (!f) {
              showToast('Select a file to scan', 'warn');
              throw new Error('Select a file to scan');
            }
            if (FILE_SCAN_MAX_BYTES > 0 && f.size > FILE_SCAN_MAX_BYTES) {
              showToast('File too large (max ' + formatBytes(FILE_SCAN_MAX_BYTES) + ')', 'error');
              throw new Error('File too large (max ' + formatBytes(FILE_SCAN_MAX_BYTES) + ')');
            }
            fd.append('file', f, f.name);
            label = f.name;
          } else {
            const payload = String(payloadEl.value || '').trim();
            if (!payload) {
              showToast('Paste a payload to scan', 'warn');
              throw new Error('Paste a payload to scan');
            }
            fd.append('payload', payload);
            fd.append('payload_base64', payloadBase64El.checked ? 'true' : 'false');
            label = payloadBase64El.checked ? 'payload (base64)' : 'payload (text)';
          }

          const resp = await apiForm('/file/scan', fd);
          showResult(resp);

          const verdictType = verdictKind(resp.verdict);
          const toastType = verdictType === 'ok' ? 'success' : (verdictType === 'bad' ? 'error' : 'info');
          showToast('Scan completed: ' + String(resp.verdict || 'unknown').toUpperCase(), toastType);
          setStatus(verdictKind(resp.verdict), 'Completed: ' + String(resp.verdict || 'unknown'));

          if (resp && resp.stored === false) {
            showToast('Result was not saved server-side (history may not include it)', 'warn', 6000);
          } else {
            await refreshHistoryFromServer({ silent: true });
          }
        } catch (e) {
          const msg = e && e.data && e.data.detail ? e.data.detail : (e && e.message ? e.message : String(e || 'Unknown error'));
          showToast(msg, 'error', 6000);
          setStatus('bad', msg);
          const errObj = {
            submitted_at: startedAt,
            scanned_at: startedAt,
            input_type: inputType,
            filename: label,
            engine: 'clamav',
            verdict: 'error',
            clamav: { error: msg },
          };
          showResult(errObj);
        } finally {
          setButtonLoading(startEl, false);
          startEl.disabled = false;
        }
      }

      function copyLastJson() {
        if (!lastResult) return;
        copyText(JSON.stringify(lastResult, null, 2));
      }

      function init() {
        loadApiKey();
        history = [];
        renderHistory();
        setActiveInput('file');
        setActiveTab('summary');

        fileHelpEl.textContent = FILE_SCAN_MAX_BYTES ? ('Max size: ' + formatBytes(FILE_SCAN_MAX_BYTES)) : '';

        // API key visibility toggle
        apiKeyToggleEl.addEventListener('click', () => {
          const isPassword = apiKeyEl.type === 'password';
          apiKeyEl.type = isPassword ? 'text' : 'password';
          apiKeyToggleEl.innerHTML = isPassword
            ? '<svg class="eye-icon" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
            : '<svg class="eye-icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
          apiKeyToggleEl.title = isPassword ? 'Hide API key' : 'Show API key';
        });

        tabInputFileEl.addEventListener('click', () => setActiveInput('file'));
        tabInputPayloadEl.addEventListener('click', () => setActiveInput('payload'));

        tabSummaryEl.addEventListener('click', () => setActiveTab('summary'));
        tabRawEl.addEventListener('click', () => setActiveTab('raw'));

        startEl.addEventListener('click', startScan);
        clearHistoryEl.addEventListener('click', clearHistoryServer);
        historyFilterEl.addEventListener('input', () => {
          historyPage = 1;
          renderHistory();
        });
        historyOrderEl.addEventListener('change', () => {
          historyPage = 1;
          renderHistory();
        });
        historyPrevEl.addEventListener('click', () => {
          if (historyPage > 1) {
            historyPage--;
            renderHistory();
          }
        });
        historyNextEl.addEventListener('click', () => {
          const totalPages = Math.max(1, Math.ceil(history.length / HISTORY_PAGE_SIZE));
          if (historyPage < totalPages) {
            historyPage++;
            renderHistory();
          }
        });
        copyJsonEl.addEventListener('click', copyLastJson);
        copyJson2El.addEventListener('click', copyLastJson);

        apiKeyEl.addEventListener('input', () => {
          const v = apiKeyEl.value.trim();
          apiKeySavedEl.style.display = v ? 'inline-flex' : 'none';
          if (v) localStorage.setItem(LS.apiKey, v);
          scheduleHistoryRefresh();
        });

        setButtonsEnabled(false);
        renderSummary({});
        renderRaw({});

        refreshHistoryFromServer({ silent: true });

        const jobId = new URLSearchParams(window.location.search).get('job');
        if (jobId) {
          if (!apiKeyEl.value.trim()) {
            showToast('Enter an API key to view this job', 'warn', 6000);
          } else {
            viewJob(jobId);
          }
        }
      }

      init();
    })();
  </script>
</body>

</html>
