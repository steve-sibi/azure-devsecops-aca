<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Azure DevSecOps URL Scanner</title>
    <meta name="description" content="Submit URL scan jobs and poll for results." />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 10px 30px rgba(0,0,0,0.08);
        --primary: #2563eb;
        --primary-ink: #ffffff;
        --success: #16a34a;
        --success-ink: #ffffff;
        --success-soft: rgba(22,163,74,0.14);
        --danger: #dc2626;
        --danger-soft: rgba(220,38,38,0.14);
        --code-bg: #0b1020;
        --code-fg: #d6e0ff;
        --ring: rgba(37, 99, 235, 0.22);
        --primary-soft: rgba(37, 99, 235, 0.12);
        --primary-soft-border: rgba(37, 99, 235, 0.45);
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b1020;
          --card: #0f172a;
          --text: #e5e7eb;
          --muted: #94a3b8;
          --border: #22304a;
          --shadow: 0 14px 40px rgba(0,0,0,0.35);
          --primary: #60a5fa;
          --primary-ink: #0b1020;
          --success: #4ade80;
          --success-ink: #0b1020;
          --success-soft: rgba(74,222,128,0.16);
          --danger: #fb7185;
          --danger-soft: rgba(251,113,133,0.16);
          --code-bg: #070b18;
          --code-fg: #d6e0ff;
          --ring: rgba(96, 165, 250, 0.26);
          --primary-soft: rgba(96, 165, 250, 0.14);
          --primary-soft-border: rgba(96, 165, 250, 0.45);
        }
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background:
          radial-gradient(1200px circle at 15% 5%, rgba(37,99,235,0.16), transparent 55%),
          radial-gradient(900px circle at 85% 18%, rgba(22,163,74,0.10), transparent 55%),
          var(--bg);
        color: var(--text);
        line-height: 1.45;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      a { color: var(--primary); }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      .app { max-width: 1440px; margin: 0 auto; padding: clamp(1.25rem, 2vw, 2rem) clamp(1rem, 3vw, 2.25rem) 3rem; }
      .header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap; }
      .header h1 { margin: 0; font-size: 1.65rem; letter-spacing: -0.02em; }
      .sub { margin: 0.35rem 0 0; color: var(--muted); line-height: 1.4; }
      .grid { margin-top: 1.25rem; display: grid; grid-template-columns: minmax(320px, 380px) 1fr; gap: 1.15rem; align-items: start; }
      @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
      .card {
        background: linear-gradient(180deg, rgba(148,163,184,0.06), rgba(148,163,184,0.02)), var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 1rem;
      }
      .card.full { grid-column: 1 / -1; }
      .card h2 { margin: 0 0 0.75rem; font-size: 1.05rem; }
      .card-head { display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
      .field { margin-bottom: 0.9rem; }
      label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 0.35rem; }
      input {
        width: 100%;
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(148,163,184,0.06);
        color: var(--text);
        transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
      }
      input::placeholder { color: var(--muted); opacity: 0.75; }
      input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--ring);
        background: rgba(148,163,184,0.04);
      }
      .url-group {
        display: flex;
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(148,163,184,0.06);
        overflow: hidden;
        transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
      }
      .url-scheme {
        display: inline-flex;
        align-items: center;
        padding: 0.65rem 0.75rem;
        font-weight: 700;
        color: var(--success-ink);
        background: var(--success);
        border-right: 1px solid rgba(0,0,0,0.18);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        white-space: nowrap;
      }
      .url-input {
        flex: 1 1 auto;
        border: none;
        background: transparent;
        padding: 0.65rem 0.75rem;
        width: auto;
      }
      .url-input:focus,
      .url-input:focus-visible {
        outline: none;
        box-shadow: none;
        background: transparent;
      }
      .url-group:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--ring);
        background: rgba(148,163,184,0.04);
      }
      .url-group:focus-within .url-scheme { border-right-color: var(--primary-soft-border); }
      .help { margin-top: 0.35rem; font-size: 0.85rem; color: var(--muted); }
      .actions { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center; }
      button {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        padding: 0.6rem 0.85rem;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 80ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
      }
      button:hover:not(:disabled) {
        background: rgba(148,163,184,0.08);
        transform: translateY(-1px);
      }
      button.primary {
        background: var(--primary);
        border-color: var(--primary);
        color: var(--primary-ink);
        font-weight: 600;
      }
      button.primary:hover:not(:disabled) { filter: brightness(1.03); }
      button:focus-visible, .tab:focus-visible, input:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px var(--ring);
      }
      button:disabled { opacity: 0.55; cursor: not-allowed; }
      .status { margin-top: 0.85rem; min-height: 1.25rem; display: flex; align-items: center; gap: 0.5rem; color: var(--muted); }
      .badge { font-size: 0.75rem; padding: 0.2rem 0.55rem; border-radius: 999px; border: 1px solid var(--border); background: transparent; color: var(--text); font-weight: 600; }
      .badge.ok { border-color: rgba(22,163,74,0.5); background: rgba(22,163,74,0.12); }
      .badge.warn { border-color: rgba(234,179,8,0.6); background: rgba(234,179,8,0.14); }
      .badge.bad { border-color: rgba(220,38,38,0.5); background: rgba(220,38,38,0.12); }
      .badge.info { border-color: var(--primary-soft-border); background: var(--primary-soft); }
      .muted { color: var(--muted); }
      .small { font-size: 0.85rem; }
      pre {
        margin: 0;
        background: var(--code-bg);
        color: var(--code-fg);
        padding: 1rem;
        border-radius: 12px;
        overflow: auto;
        border: 1px solid var(--border);
        font-size: 0.9rem;
        line-height: 1.45;
      }
      .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: rgba(148,163,184,0.03); }
      table { width: 100%; border-collapse: collapse; min-width: 720px; }
      th, td { text-align: left; padding: 0.55rem 0.65rem; border-bottom: 1px solid var(--border); vertical-align: top; }
      th {
        font-size: 0.78rem;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: var(--muted);
        background: rgba(148,163,184,0.10);
        position: sticky;
        top: 0;
      }
      tr:last-child td { border-bottom: none; }
      .nowrap { white-space: nowrap; }
      .url-cell { max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .filter { flex: 1; min-width: 220px; }
      .tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.25rem 0 0.85rem; }
      .tab {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        padding: 0.45rem 0.7rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .tab[aria-selected="true"] {
        background: var(--primary-soft);
        border-color: var(--primary-soft-border);
      }
      .panel.hidden { display: none; }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
        align-items: start;
      }
      .summary-col { display: flex; flex-direction: column; gap: 1rem; min-width: 0; }
      @media (max-width: 900px) { .summary-grid { grid-template-columns: 1fr; } }
      .summary-block {
        --dot: var(--primary);
        --dot-soft: var(--primary-soft);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0.95rem;
        background: rgba(148,163,184,0.04);
        backdrop-filter: blur(10px);
        align-self: start;
        height: fit-content;
      }
      .summary-block.tone-ok { --dot: var(--success); --dot-soft: var(--success-soft); }
      .summary-block.tone-bad { --dot: var(--danger); --dot-soft: var(--danger-soft); }
      .summary-block h3 {
        margin: 0 0 0.75rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.55rem;
        padding-bottom: 0.55rem;
        border-bottom: 1px solid rgba(148,163,184,0.14);
      }
      .summary-block h3::before {
        content: "";
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--dot);
        box-shadow: 0 0 0 4px var(--dot-soft);
        opacity: 0.9;
        flex: 0 0 auto;
      }
      .summary-title { font-weight: 700; letter-spacing: -0.01em; }
      .summary-meta { margin-left: auto; display: inline-flex; flex-wrap: wrap; gap: 0.35rem; justify-content: flex-end; }
      dl.kv { display: block; margin: 0; }
      dl.kv .kv-row {
        display: grid;
        grid-template-columns: minmax(120px, 170px) 1fr;
        gap: 0.35rem 0.8rem;
        padding: 0.4rem 0;
      }
      dl.kv .kv-row + .kv-row { border-top: 1px solid rgba(148,163,184,0.14); }
      dl.kv dt {
        color: var(--muted);
        font-size: 0.72rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        padding-top: 0.12rem;
      }
      dl.kv dd {
        margin: 0;
        overflow-wrap: anywhere;
        font-weight: 500;
        font-variant-numeric: tabular-nums;
        line-height: 1.35;
      }
      .value-inline { display: inline-flex; gap: 0.35rem; flex-wrap: wrap; align-items: center; }
      .value-row { display: flex; align-items: flex-start; gap: 0.5rem; justify-content: space-between; width: 100%; }
      .value-row > :first-child { flex: 1 1 auto; min-width: 0; }
      .value-row .icon-btn { flex: 0 0 auto; }
      .value-code {
        display: inline-block;
        padding: 0.18rem 0.45rem;
        border-radius: 10px;
        border: 1px solid rgba(148,163,184,0.22);
        background: rgba(148,163,184,0.08);
        font-size: 0.86rem;
        line-height: 1.2;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .value-link {
        text-decoration: none;
        border-bottom: 1px dashed rgba(148,163,184,0.45);
      }
      .value-link:hover { border-bottom-color: var(--primary); }
      .icon-btn {
        padding: 0.3rem 0.55rem;
        border-radius: 10px;
        font-size: 0.78rem;
        line-height: 1;
        border: 1px solid rgba(148,163,184,0.28);
        background: rgba(148,163,184,0.08);
      }
      .icon-btn:hover:not(:disabled) {
        background: rgba(148,163,184,0.14);
        transform: none;
      }
      details.disclosure {
        border: 1px solid rgba(148,163,184,0.22);
        border-radius: 12px;
        padding: 0.35rem 0.55rem;
        background: rgba(148,163,184,0.06);
      }
      details.disclosure summary {
        cursor: pointer;
        user-select: none;
        list-style: none;
        color: var(--muted);
        font-size: 0.85rem;
      }
      details.disclosure summary::-webkit-details-marker { display: none; }
      details.disclosure summary::before {
        content: "▸";
        display: inline-block;
        margin-right: 0.35rem;
        color: var(--muted);
      }
      details.disclosure[open] summary { color: var(--text); }
      details.disclosure[open] summary::before { content: "▾"; }
      details.disclosure pre {
        margin-top: 0.6rem;
        padding: 0.75rem;
        border-radius: 12px;
        font-size: 0.82rem;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <div>
          <h1>Azure DevSecOps URL Scanner</h1>
          <p class="sub">Submit scan jobs and poll results. Swagger: <a href="/docs">/docs</a>. API key required for scan endpoints.</p>
        </div>
        <div class="actions">
          <button id="clearHistory" type="button">Clear history</button>
        </div>
      </header>

      <div class="grid">
        <section class="card">
          <h2>New scan</h2>
          <div class="field">
            <label for="apiKey">API key <span class="muted">(header: __API_KEY_HEADER__)</span></label>
            <input id="apiKey" autocomplete="off" placeholder="Paste API key" />
            <div class="help">Saved in this browser only (local storage).</div>
          </div>
          <div class="field">
            <label for="url">HTTPS URL to scan</label>
            <div class="url-group">
              <span class="url-scheme" aria-hidden="true">https://</span>
              <input id="url" class="url-input" inputmode="url" autocomplete="off" placeholder="example.com" />
            </div>
            <div class="help">Only public HTTPS destinations on port 443 are allowed.</div>
          </div>
          <div class="actions">
            <button id="start" class="primary" type="button">Start scan</button>
            <button id="checkCurrent" type="button" disabled>Check job</button>
            <button id="copyJson" type="button" disabled>Copy JSON</button>
          </div>
          <div id="status" class="status" aria-live="polite"></div>
        </section>

        <section class="card">
          <div class="card-head">
            <h2>History</h2>
            <input id="historyFilter" class="filter" placeholder="Filter by URL or job id" />
          </div>
          <div class="table-wrap" role="region" aria-label="Scan history">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">When</th>
                  <th>URL</th>
                  <th class="nowrap">Job</th>
                  <th class="nowrap">Status</th>
                  <th class="nowrap">Actions</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
          <p class="muted small">History is stored locally in your browser.</p>
        </section>

        <section class="card full">
          <div class="card-head">
            <h2>Response</h2>
            <div class="actions">
              <button id="copyJson2" type="button" disabled>Copy JSON</button>
            </div>
          </div>
          <div class="tabs" role="tablist" aria-label="Response view">
            <button id="tabSummary" class="tab" role="tab" aria-selected="true" type="button">Summary</button>
            <button id="tabRaw" class="tab" role="tab" aria-selected="false" type="button">Raw JSON</button>
          </div>
          <div id="panelSummary" class="panel">
            <div id="summaryOut" class="summary-grid"></div>
          </div>
          <div id="panelRaw" class="panel hidden">
            <pre id="out">{}</pre>
          </div>
        </section>
      </div>
    </div>

    <script>
      (function () {
        const API_KEY_HEADER = __API_KEY_HEADER_JSON__;
        const MAX_POLL_SECONDS = __MAX_DASHBOARD_POLL_SECONDS__;

        const LS = {
          apiKey: 'acaScanner.apiKey',
          history: 'acaScanner.scanHistory.v1',
          legacyApiKey: 'apiKey',
        };

        const apiKeyEl = document.getElementById('apiKey');
        const urlEl = document.getElementById('url');
        const outEl = document.getElementById('out');
        const summaryOutEl = document.getElementById('summaryOut');
        const statusEl = document.getElementById('status');
        const startEl = document.getElementById('start');
        const historyBodyEl = document.getElementById('historyBody');
        const historyFilterEl = document.getElementById('historyFilter');
        const clearHistoryEl = document.getElementById('clearHistory');
        const checkCurrentEl = document.getElementById('checkCurrent');
        const copyJsonEl = document.getElementById('copyJson');
        const copyJson2El = document.getElementById('copyJson2');
        const tabSummaryEl = document.getElementById('tabSummary');
        const tabRawEl = document.getElementById('tabRaw');
        const panelSummaryEl = document.getElementById('panelSummary');
        const panelRawEl = document.getElementById('panelRaw');

        let history = [];
        let currentJobId = null;
        let isPolling = false;
        let activeTab = 'summary'; // 'summary' | 'raw'

        let lastSummary = null; // most recent response for summary view
        let lastFull = null; // most recent response for full view (raw JSON)
        let lastSummaryJobId = null;
        let lastFullJobId = null;

        const dtf = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });
        const HTTPS_PREFIX = 'https://';

        function normalizeUrlInput(raw) {
          const v = String(raw || '').trim();
          if (!v) return '';
          return v.replace(/^https:\/\//i, '');
        }

        function toHttpsUrl(raw) {
          const v = String(raw || '').trim();
          if (!v) return '';
          if (/^https:\/\//i.test(v)) return v;
          if (/^http:\/\//i.test(v)) throw new Error('Only HTTPS URLs are allowed');
          return HTTPS_PREFIX + v.replace(/^\/+/, '');
        }

        function readJson(key, fallback) {
          try {
            const raw = localStorage.getItem(key);
            if (!raw) return fallback;
            return JSON.parse(raw);
          } catch (_) {
            return fallback;
          }
        }

        function writeJson(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }

        function loadHistory() {
          const items = readJson(LS.history, []);
          if (!Array.isArray(items)) return [];
          return items.filter(Boolean).slice(0, 50);
        }

        function saveHistory() {
          writeJson(LS.history, history.slice(0, 50));
        }

        function upsertHistory(entry) {
          const idx = history.findIndex(x => x && x.job_id === entry.job_id);
          if (idx >= 0) history[idx] = Object.assign({}, history[idx], entry);
          else history.unshift(entry);
          history = history.slice(0, 50);
          saveHistory();
          renderHistory();
        }

        function patchHistory(jobId, patch) {
          const idx = history.findIndex(x => x && x.job_id === jobId);
          if (idx < 0) return;
          history[idx] = Object.assign({}, history[idx], patch);
          saveHistory();
          renderHistory();
        }

        function clearHistory() {
          history = [];
          saveHistory();
          renderHistory();
        }

        function el(tag, attrs) {
          const node = document.createElement(tag);
          if (attrs) {
            for (const [k, v] of Object.entries(attrs)) {
              if (k === 'class') node.className = v;
              else if (k === 'text') node.textContent = v;
              else if (k === 'title') node.title = v;
              else if (k === 'href') node.href = v;
              else if (k === 'target') node.target = v;
              else if (k === 'rel') node.rel = v;
              else node.setAttribute(k, v);
            }
          }
          for (let i = 2; i < arguments.length; i++) {
            const child = arguments[i];
            if (child == null) continue;
            if (typeof child === 'string') node.appendChild(document.createTextNode(child));
            else node.appendChild(child);
          }
          return node;
        }

        function makeBadge(kind, label) {
          const cls = kind ? ('badge ' + kind) : 'badge';
          return el('span', { class: cls, text: label });
        }

        function setStatus(kind, text) {
          statusEl.textContent = '';
          if (!text) return;
          const label = kind === 'ok' ? 'OK' : (kind === 'bad' ? 'ERROR' : (kind === 'warn' ? 'WARN' : 'INFO'));
          statusEl.appendChild(makeBadge(kind || 'info', label));
          statusEl.appendChild(document.createTextNode(' ' + text));
        }

        function setButtonsEnabled(hasJson) {
          copyJsonEl.disabled = !hasJson;
          copyJson2El.disabled = !hasJson;
          checkCurrentEl.disabled = !currentJobId;
        }

        function formatBytes(n) {
          const v = Number(n);
          if (!Number.isFinite(v)) return '';
          if (v < 1024) return v + ' B';
          const kb = v / 1024;
          if (kb < 1024) return kb.toFixed(1) + ' KB';
          const mb = kb / 1024;
          return mb.toFixed(2) + ' MB';
        }

        function formatMs(n) {
          const v = Number(n);
          if (!Number.isFinite(v)) return '';
          if (v < 1000) return v + ' ms';
          return (v / 1000).toFixed(2) + ' s';
        }

        function pick(obj, key) {
          if (!obj || typeof obj !== 'object') return null;
          return obj[key];
        }

        function badgeValue(kind, text) {
          const label = String(text || '');
          return makeBadge(kind || 'info', label);
        }

        function renderSummary(resp) {
          summaryOutEl.textContent = '';
          const data = resp || {};
          const s = (data && data.summary && typeof data.summary === 'object') ? data.summary : {};

          const blocks = [];

          function makeCopyButton(text, label) {
            const hint = label || 'Copy';
            const btn = el('button', { type: 'button', class: 'icon-btn', title: hint, 'aria-label': hint }, 'Copy');
            btn.addEventListener('click', () => copyText(text));
            return btn;
          }

          function copyableValue(valueNode, text, label) {
            const v = String(text || '');
            if (!v) return valueNode;
            return el('span', { class: 'value-row' }, valueNode, makeCopyButton(v, label));
          }

          function codeValue(value, opts) {
            const text = value == null ? '' : String(value);
            const node = el('code', { class: 'value-code', text: text });
            if (opts && opts.copy) return copyableValue(node, text, opts.copyLabel);
            return node;
          }

          function linkValue(url, opts) {
            const href = String(url || '');
            const node = el('a', { class: 'value-link', href: href, target: '_blank', rel: 'noreferrer', text: href });
            if (opts && opts.copy) return copyableValue(node, href, opts.copyLabel);
            return node;
          }

          function block(title, rows, opts) {
            const dl = el('dl', { class: 'kv' });
            for (const [k, v] of rows) {
              if (v == null || v === '') continue;
              const row = el('div', { class: 'kv-row' });
              row.appendChild(el('dt', { text: k }));
              const dd = el('dd');
              if (v && typeof v === 'object' && v.nodeType === 1) dd.appendChild(v);
              else dd.textContent = String(v);
              row.appendChild(dd);
              dl.appendChild(row);
            }
            const header = el('h3', null, el('span', { class: 'summary-title', text: title }));
            const metaNodes = (opts && Array.isArray(opts.meta)) ? opts.meta.filter(Boolean) : [];
            if (metaNodes.length) header.appendChild(el('span', { class: 'summary-meta' }, ...metaNodes));
            const tone = opts && opts.tone ? String(opts.tone) : '';
            blocks.push(el('div', { class: 'summary-block' + (tone ? (' tone-' + tone) : '') }, header, dl));
          }

          const status = data.status || 'unknown';
          const verdict = data.verdict || '';
          const url = s.url || '';
          const sha = s.sha256 || '';
          const engines = Array.isArray(s.engines) ? s.engines.join(', ') : '';
          const size = (s.size_bytes != null ? formatBytes(s.size_bytes) : formatBytes(data.size_bytes));
          const dur = (s.duration_ms != null ? formatMs(s.duration_ms) : formatMs(data.duration_ms));

          const jobTone = statusKind(status);
          block('Job', [
            ['Job ID', (data.job_id ? codeValue(data.job_id, { copy: true, copyLabel: 'Copy job id' }) : '')],
            ['Submitted', formatWhen(data.submitted_at)],
            ['Scanned', formatWhen(data.scanned_at)],
            ['Duration', dur ? codeValue(dur) : ''],
            ['Size', size ? codeValue(size) : ''],
            ['Engines', engines ? codeValue(engines) : ''],
          ], {
            tone: jobTone,
            meta: [
              badgeValue(jobTone, status),
              verdict ? badgeValue(verdictKind(verdict), verdict) : null,
            ],
          });

          block('Target', [
            ['URL', url ? linkValue(url, { copy: true, copyLabel: 'Copy url' }) : ''],
            ['SHA-256', sha ? codeValue(sha, { copy: true, copyLabel: 'Copy sha-256' }) : ''],
            ['Download blocked', (s.download_blocked === true ? 'yes' : (s.download_blocked === false ? 'no' : ''))],
          ], { tone: 'info' });

          const decision = pick(s, 'decision');
          if (decision) {
            const decVerdict = String(decision.final_verdict || '');
            const decTone = verdictKind(decVerdict);
            block('Decision', [
              ['Final verdict', decVerdict ? badgeValue(verdictKind(decVerdict), decVerdict) : ''],
              ['Confidence', (decision.confidence != null ? codeValue(decision.confidence) : '')],
              ['Action', decision.action ? codeValue(decision.action) : ''],
              ['Reasons', Array.isArray(decision.reasons) ? decision.reasons.join(', ') : ''],
            ], { tone: decTone });
          }

          if (data.error) {
            block('Error', [['Message', data.error]], { tone: 'bad' });
          }

          const rep = pick(s, 'reputation');
          if (rep) {
            const repTone = verdictKind(rep.verdict);
            block('Reputation', [
              ['Verdict', rep.verdict ? badgeValue(verdictKind(rep.verdict), rep.verdict) : ''],
              ['Score', rep.score != null ? codeValue(rep.score) : ''],
              ['Suspicious threshold', rep.suspicious_threshold != null ? codeValue(rep.suspicious_threshold) : ''],
              ['Malicious threshold', rep.malicious_threshold != null ? codeValue(rep.malicious_threshold) : ''],
              ['Matched rules', Array.isArray(rep.matched_rules) ? rep.matched_rules.join(', ') : ''],
              ['Reasons', Array.isArray(rep.reasons) ? rep.reasons.join(', ') : ''],
              ['Allowlist match', rep.matched_allowlist],
              ['Blocklist match', rep.matched_blocklist],
            ], { tone: repTone });
          }

          const content = pick(s, 'content');
          if (content) {
            const hasForm = (content.has_form === true);
            const hasPassword = (content.has_password_field === true);
            const hasMeta = (content.has_meta_refresh === true);
            const prim = Array.isArray(content.js_obfuscation_primitives) ? content.js_obfuscation_primitives : [];
            const b64 = Number(content.base64_blob_max_len);
            const suspicious = (hasForm && hasPassword) || hasMeta || (prim.length >= 2) || (Number.isFinite(b64) && b64 >= 5000);
            const tone = suspicious ? 'bad' : 'info';
            block('Content', [
              ['Content-Type', content.content_type ? codeValue(String(content.content_type)) : ''],
              ['Text bytes scanned', (content.text_bytes_scanned != null ? codeValue(String(content.text_bytes_scanned)) : '')],
              ['Has form', (content.has_form === true ? 'yes' : (content.has_form === false ? 'no' : ''))],
              ['Has password field', (content.has_password_field === true ? 'yes' : (content.has_password_field === false ? 'no' : ''))],
              ['Meta refresh', (content.has_meta_refresh === true ? 'yes' : (content.has_meta_refresh === false ? 'no' : ''))],
              ['JS primitives', prim.length ? prim.join(', ') : ''],
              ['Max base64 blob', (Number.isFinite(b64) ? codeValue(String(b64)) : '')],
            ], { tone: tone });
          }

          const dl = pick(s, 'download');
          if (dl) {
            block('Download', [
              ['Requested URL', dl.requested_url ? linkValue(dl.requested_url, { copy: true, copyLabel: 'Copy requested url' }) : ''],
              ['Final URL', dl.final_url ? linkValue(dl.final_url, { copy: true, copyLabel: 'Copy final url' }) : ''],
              ['Content-Type', dl.content_type ? codeValue(dl.content_type) : ''],
              ['Redirects', dl.redirect_count != null ? codeValue(dl.redirect_count) : ''],
              ['Blocked', (dl.blocked === true ? 'yes' : (dl.blocked === false ? 'no' : ''))],
            ], { tone: (dl.blocked === true ? 'ok' : 'info') });
          }

          if (blocks.length === 0) {
            summaryOutEl.appendChild(el('div', { class: 'muted', text: 'No data yet.' }));
            return;
          }
          const isNarrow = window.matchMedia('(max-width: 900px)').matches;
          const colCount = isNarrow ? 1 : 2;
          const cols = [];
          for (let i = 0; i < colCount; i++) cols.push(el('div', { class: 'summary-col' }));
          for (let i = 0; i < blocks.length; i++) cols[i % colCount].appendChild(blocks[i]);
          for (const c of cols) summaryOutEl.appendChild(c);
        }

        function renderRaw(resp) {
          const obj = resp || {};
          outEl.textContent = JSON.stringify(obj, null, 2);
        }

        function showSummary(obj) {
          lastSummary = obj;
          lastSummaryJobId = (obj && obj.job_id) ? obj.job_id : null;
          renderSummary(obj);
          setButtonsEnabled(true);
        }

        function showFull(obj) {
          lastFull = obj;
          lastSummary = obj;
          lastFullJobId = (obj && obj.job_id) ? obj.job_id : null;
          lastSummaryJobId = lastFullJobId;
          renderSummary(obj);
          if (activeTab === 'raw') renderRaw(obj);
          setButtonsEnabled(true);
        }

        function showPlaceholder() {
          renderSummary(lastSummary || lastFull || {});
          if (activeTab === 'raw') {
            outEl.textContent = JSON.stringify({ message: 'Raw JSON not loaded yet. Click "Check job" or switch tabs.' }, null, 2);
          }
          setButtonsEnabled(Boolean(lastSummary || lastFull));
        }

        function setActiveTab(next) {
          activeTab = next;
          const isSummary = next === 'summary';
          tabSummaryEl.setAttribute('aria-selected', isSummary ? 'true' : 'false');
          tabRawEl.setAttribute('aria-selected', isSummary ? 'false' : 'true');
          panelSummaryEl.classList.toggle('hidden', !isSummary);
          panelRawEl.classList.toggle('hidden', isSummary);

          if (!isSummary) {
            if (lastFull && (!currentJobId || lastFullJobId === currentJobId)) renderRaw(lastFull);
            else showPlaceholder();
          } else {
            renderSummary(lastSummary || lastFull || {});
          }
        }

        let _resizeTimer = null;
        window.addEventListener('resize', () => {
          if (_resizeTimer) clearTimeout(_resizeTimer);
          _resizeTimer = setTimeout(() => {
            renderSummary(lastSummary || lastFull || {});
          }, 120);
        });

        async function copyText(text) {
          try {
            await navigator.clipboard.writeText(text);
            setStatus('ok', 'Copied to clipboard');
          } catch (_) {
            const ta = el('textarea', { style: 'position:fixed;left:-1000px;top:-1000px;' });
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
            setStatus('ok', 'Copied to clipboard');
          }
        }

        async function api(path, method, body) {
          const headers = { 'content-type': 'application/json' };
          const key = apiKeyEl.value.trim();
          if (key) headers[API_KEY_HEADER] = key;
          const res = await fetch(path, {
            method: method,
            headers: headers,
            body: body ? JSON.stringify(body) : undefined
          });
          const text = await res.text();
          let data;
          try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
          if (!res.ok) {
            const err = new Error('HTTP ' + res.status);
            err.status = res.status;
            err.data = data;
            throw err;
          }
          return data;
        }

        function formatWhen(iso) {
          if (!iso) return '';
          try { return dtf.format(new Date(iso)); } catch (_) { return iso; }
        }

        function statusKind(status) {
          if (status === 'completed') return 'ok';
          if (status === 'error') return 'bad';
          return 'info';
        }

        function verdictKind(verdict) {
          if (!verdict) return 'info';
          const v = String(verdict).toLowerCase();
          if (v === 'benign' || v === 'clean') return 'ok';
          if (v === 'suspicious') return 'warn';
          if (v === 'malicious' || v === 'error') return 'bad';
          return 'info';
        }

        function renderHistory() {
          const filter = (historyFilterEl.value || '').trim().toLowerCase();
          historyBodyEl.textContent = '';

          const items = history.filter(item => {
            if (!item) return false;
            if (!filter) return true;
            const hay = (String(item.url || '') + ' ' + String(item.job_id || '')).toLowerCase();
            return hay.indexOf(filter) >= 0;
          });

          if (items.length === 0) {
            const msg = filter ? 'No matching scans.' : 'No scans yet. Start one to see it here.';
            const td = el('td', { class: 'muted', text: msg });
            td.colSpan = 5;
            historyBodyEl.appendChild(el('tr', null, td));
            return;
          }

          for (const item of items) {
            const when = formatWhen(item.submitted_at || item.last_checked_at);
            const job = item.job_id || '';
            const shortJob = job ? (job.slice(0, 8) + '…') : '';
            const s = String(item.status || 'unknown');

            const whenTd = el('td', { class: 'nowrap', text: when });

            const urlLink = el('a', { href: item.url || '#', target: '_blank', rel: 'noreferrer', text: item.url || '' });
            const urlTd = el('td', { class: 'url-cell' }, urlLink);

            const jobCode = el('code', { text: shortJob, title: job });
            const jobTd = el('td', { class: 'nowrap' }, jobCode);

            const statusTd = el('td', { class: 'nowrap' });
            statusTd.appendChild(makeBadge(statusKind(s), s));
            if (item.verdict) {
              statusTd.appendChild(document.createTextNode(' '));
              statusTd.appendChild(makeBadge(verdictKind(item.verdict), String(item.verdict)));
            }

            const actionsTd = el('td', { class: 'nowrap' });
            const useBtn = el('button', { type: 'button', text: 'Use URL' });
            useBtn.addEventListener('click', () => {
              if (!item.url) return;
              urlEl.value = normalizeUrlInput(item.url);
              urlEl.focus();
              setStatus('info', 'Loaded URL from history');
            });

            const checkBtn = el('button', { type: 'button', text: 'Check' });
            checkBtn.addEventListener('click', () => refreshJob(job, true));

            const setCurrentBtn = el('button', { type: 'button', text: 'Set current' });
            setCurrentBtn.addEventListener('click', () => {
              currentJobId = job;
              if (currentJobId && lastFullJobId && lastFullJobId !== currentJobId) {
                lastFull = null;
                lastFullJobId = null;
              }
              if (currentJobId && lastSummaryJobId && lastSummaryJobId !== currentJobId) {
                lastSummary = null;
                lastSummaryJobId = null;
              }
              setButtonsEnabled(true);
              setStatus('info', 'Current job set to ' + job);
              showPlaceholder();
            });

            actionsTd.appendChild(useBtn);
            actionsTd.appendChild(checkBtn);
            actionsTd.appendChild(setCurrentBtn);

            historyBodyEl.appendChild(el('tr', null, whenTd, urlTd, jobTd, statusTd, actionsTd));
          }
        }

        async function refreshJob(jobId, showOutput) {
          if (!jobId) return null;
          setStatus('info', 'Fetching status for ' + jobId + '...');
          try {
            const view = activeTab === 'raw' ? 'full' : 'summary';
            const s = await api('/scan/' + jobId + '?view=' + encodeURIComponent(view), 'GET');
            const now = new Date().toISOString();
            patchHistory(jobId, {
              status: s.status,
              verdict: s.verdict || null,
              error: s.error || null,
              submitted_at: s.submitted_at || undefined,
              scanned_at: s.scanned_at || null,
              last_checked_at: now
            });
            if (showOutput) {
              if (view === 'full') showFull(s);
              else showSummary(s);
            } else {
              // Still update summary so the UI stays current while polling.
              showSummary(s);
            }
            setStatus(statusKind(s.status), 'Job ' + jobId + ' is ' + s.status);
            return s;
          } catch (e) {
            const msg = e && e.data ? JSON.stringify(e.data) : (e ? e.message : 'Unknown error');
            setStatus('bad', msg);
            if (showOutput) showSummary({ error: msg });
            return null;
          }
        }

        async function loadFull(jobId) {
          if (!jobId) return null;
          try {
            const full = await api('/scan/' + jobId + '?view=full', 'GET');
            lastFull = full;
            lastFullJobId = (full && full.job_id) ? full.job_id : jobId;
            if (activeTab === 'raw' && (!currentJobId || currentJobId === jobId)) {
              renderRaw(full);
              setButtonsEnabled(true);
            }
            return full;
          } catch (_) {
            return null;
          }
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        async function pollJob(jobId) {
          const deadline = Date.now() + (MAX_POLL_SECONDS * 1000);
          while (Date.now() < deadline) {
            const s = await refreshJob(jobId, true);
            if (s && (s.status === 'completed' || s.status === 'error')) {
              // Preload full payload for the Raw JSON tab once the job is terminal.
              if (!lastFull || lastFullJobId !== jobId) {
                await loadFull(jobId);
              }
              return s;
            }
            await sleep(4000);
          }
          throw new Error('Timed out waiting for result');
        }

        async function startScan() {
          if (isPolling) return;
          let target = '';
          try {
            target = toHttpsUrl(urlEl.value);
          } catch (e) {
            setStatus('bad', e ? e.message : 'Only HTTPS URLs are allowed');
            return;
          }
          if (!target) {
            setStatus('bad', 'Enter a URL');
            return;
          }

          setStatus('info', 'Submitting scan...');
          showSummary({
            status: 'submitting',
            verdict: null,
            error: null,
            submitted_at: new Date().toISOString(),
            scanned_at: null,
            summary: { url: target }
          });
          setButtonsEnabled(false);
          startEl.disabled = true;
          checkCurrentEl.disabled = true;

          try {
            const submit = await api('/scan', 'POST', { url: target, type: 'url' });
            lastFull = null;
            lastFullJobId = null;
            showSummary(submit);

            currentJobId = submit.job_id || null;
            setButtonsEnabled(true);

            if (currentJobId) {
              const now = new Date().toISOString();
              upsertHistory({
                job_id: currentJobId,
                url: target,
                status: submit.status || 'queued',
                verdict: null,
                error: null,
                submitted_at: now,
                scanned_at: null,
                last_checked_at: null
              });
            }

            if (!currentJobId) {
              setStatus('bad', 'No job_id returned');
              return;
            }

            isPolling = true;
            setStatus('info', 'Job queued; polling for results...');
            const result = await pollJob(currentJobId);
            if (result && result.status === 'completed') setStatus('ok', 'Completed');
            else setStatus('bad', 'Error');
          } catch (e) {
            const msg = e && e.data ? JSON.stringify(e.data) : (e ? e.message : 'Unknown error');
            setStatus('bad', msg);
            showSummary({ status: 'error', error: msg, summary: { url: target } });
          } finally {
            isPolling = false;
            startEl.disabled = false;
            setButtonsEnabled(true);
          }
        }

        function init() {
          const stored = localStorage.getItem(LS.apiKey) || localStorage.getItem(LS.legacyApiKey) || '';
          apiKeyEl.value = stored;
          if (stored && !localStorage.getItem(LS.apiKey)) localStorage.setItem(LS.apiKey, stored);

          apiKeyEl.addEventListener('input', () => localStorage.setItem(LS.apiKey, apiKeyEl.value));
          const stripSchemeIfPresent = () => {
            const next = normalizeUrlInput(urlEl.value);
            if (next !== urlEl.value) urlEl.value = next;
          };
          urlEl.addEventListener('blur', stripSchemeIfPresent);
          urlEl.addEventListener('paste', () => setTimeout(stripSchemeIfPresent, 0));
          history = loadHistory();
          renderHistory();
          lastSummary = {};
          lastFull = null;
          showPlaceholder();
          setButtonsEnabled(false);
        }

        startEl.addEventListener('click', startScan);
        checkCurrentEl.addEventListener('click', () => refreshJob(currentJobId, true));
        clearHistoryEl.addEventListener('click', () => {
          clearHistory();
          setStatus('ok', 'History cleared');
        });
        historyFilterEl.addEventListener('input', renderHistory);
        tabSummaryEl.addEventListener('click', () => setActiveTab('summary'));
        tabRawEl.addEventListener('click', async () => {
          setActiveTab('raw');
          if (currentJobId && (!lastFull || lastFullJobId !== currentJobId)) {
            await refreshJob(currentJobId, true);
          }
        });

        copyJsonEl.addEventListener('click', async () => {
          const text = activeTab === 'raw'
            ? (outEl.textContent || '')
            : JSON.stringify((lastSummary && lastSummary.summary) ? lastSummary.summary : (lastSummary || {}), null, 2);
          if (text) await copyText(text);
        });
        copyJson2El.addEventListener('click', async () => {
          const text = activeTab === 'raw'
            ? (outEl.textContent || '')
            : JSON.stringify((lastSummary && lastSummary.summary) ? lastSummary.summary : (lastSummary || {}), null, 2);
          if (text) await copyText(text);
        });

        init();
        setActiveTab('summary');
      })();
    </script>
  </body>
</html>
