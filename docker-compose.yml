services:
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  artifacts-init:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    user: "0"
    command: ["sh", "-c", "mkdir -p /artifacts && chmod 777 /artifacts"]
    volumes:
      - artifacts:/artifacts

  clamav:
    build:
      context: ./app
      dockerfile: clamav/Dockerfile
    command:
      - sh
      - -c
      - freshclam --config-file=/etc/clamav/freshclam.conf && exec /usr/sbin/clamd --config-file=/etc/clamav/clamd.compose.conf

  jaeger:
    image: jaegertracing/all-in-one:1.59.0
    profiles: ["observability"]
    command:
      - "--collector.otlp.enabled=true"
      - "--collector.otlp.http.host-port=:4318"
      - "--collector.otlp.grpc.host-port=:4317"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"
      - "4318:4318"
      - "4317:4317"

  api:
    build:
      context: ./app
      dockerfile: api/Dockerfile
    ports:
      - "8000:8000"
    environment:
      LOG_FORMAT: ${LOG_FORMAT:-pretty}
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_TRACES_SAMPLER_RATIO: ${OTEL_TRACES_SAMPLER_RATIO:-0.10}
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-aca-urlscanner}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS:-}
      PORT: "8000"
      QUEUE_NAME: ${QUEUE_NAME:-tasks}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_QUEUE_KEY:-queue:tasks}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      URL_DEDUPE_TTL_SECONDS: ${URL_DEDUPE_TTL_SECONDS:-0}
      URL_DEDUPE_IN_PROGRESS_TTL_SECONDS: ${URL_DEDUPE_IN_PROGRESS_TTL_SECONDS:-0}
      URL_DEDUPE_SCOPE: ${URL_DEDUPE_SCOPE:-global}
      URL_DEDUPE_INDEX_PARTITION: ${URL_DEDUPE_INDEX_PARTITION:-urlidx}
      REDIS_URL_INDEX_PREFIX: ${REDIS_URL_INDEX_PREFIX:-urlidx:}
      SCREENSHOT_REDIS_PREFIX: ${SCREENSHOT_REDIS_PREFIX:-screenshot:}
      SCREENSHOT_CONTAINER: ${SCREENSHOT_CONTAINER:-screenshots}
      SCREENSHOT_FORMAT: ${SCREENSHOT_FORMAT:-jpeg}
      # Note: use ACA_API_KEY to avoid collisions with shell-exported API_KEY variables.
      API_KEY: ${ACA_API_KEY:-local-dev-key}
      ACA_API_KEYS: ${ACA_API_KEYS:-}
      API_ADMIN_KEY: ${API_ADMIN_KEY:-}
      API_ADMIN_KEYS: ${API_ADMIN_KEYS:-}
      REQUIRE_API_KEY: ${REQUIRE_API_KEY:-true}
      API_KEY_STORE_ENABLED: ${API_KEY_STORE_ENABLED:-true}
      API_KEY_STORE_PARTITION: ${API_KEY_STORE_PARTITION:-apikeys}
      REDIS_API_KEY_PREFIX: ${REDIS_API_KEY_PREFIX:-apikey:}
      REDIS_API_KEY_INDEX_KEY: ${REDIS_API_KEY_INDEX_KEY:-apikeys:index}
      API_KEY_MINT_PREFIX: ${API_KEY_MINT_PREFIX:-aca}
      API_KEY_MINT_BYTES: ${API_KEY_MINT_BYTES:-32}
      API_KEY_HEADER: ${API_KEY_HEADER:-X-API-Key}
      RATE_LIMIT_RPM: ${RATE_LIMIT_RPM:-60}
      RATE_LIMIT_WRITE_RPM: ${RATE_LIMIT_WRITE_RPM:-60}
      RATE_LIMIT_READ_RPM: ${RATE_LIMIT_READ_RPM:-300}
      RATE_LIMIT_WINDOW_SECONDS: ${RATE_LIMIT_WINDOW_SECONDS:-60}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      CLAMAV_HOST: ${CLAMAV_HOST:-clamav}
      CLAMAV_PORT: ${CLAMAV_PORT:-3310}
      CLAMAV_TIMEOUT_SECONDS: ${CLAMAV_TIMEOUT_SECONDS:-8}
      FILE_SCAN_MAX_BYTES: ${FILE_SCAN_MAX_BYTES:-10485760}
      FILE_SCAN_INCLUDE_VERSION: ${FILE_SCAN_INCLUDE_VERSION:-true}
      WEBPUBSUB_CONNECTION_STRING: ${WEBPUBSUB_CONNECTION_STRING:-}
      WEBPUBSUB_HUB: ${WEBPUBSUB_HUB:-scans}
      WEBPUBSUB_TOKEN_TTL_MINUTES: ${WEBPUBSUB_TOKEN_TTL_MINUTES:-60}
      WEBPUBSUB_GROUP_PREFIX: ${WEBPUBSUB_GROUP_PREFIX:-run}
      WEBPUBSUB_USER_GROUP_PREFIX: ${WEBPUBSUB_USER_GROUP_PREFIX:-apikey}
    depends_on:
      redis:
        condition: service_healthy
      clamav:
        condition: service_started
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthz').read()
      interval: 10s
      timeout: 3s
      retries: 20

  fetcher:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    environment:
      LOG_FORMAT: ${LOG_FORMAT:-pretty}
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_TRACES_SAMPLER_RATIO: ${OTEL_TRACES_SAMPLER_RATIO:-0.10}
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-aca-urlscanner}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS:-}
      WORKER_MODE: fetcher
      QUEUE_NAME: ${QUEUE_NAME:-tasks}
      SCAN_QUEUE_NAME: ${SCAN_QUEUE_NAME:-tasks-scan}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_QUEUE_KEY:-queue:tasks}
      REDIS_DLQ_KEY: ${REDIS_FETCHER_DLQ_KEY:-dlq:tasks}
      REDIS_SCAN_QUEUE_KEY: ${REDIS_SCAN_QUEUE_KEY:-queue:tasks-scan}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      URL_DEDUPE_TTL_SECONDS: ${URL_DEDUPE_TTL_SECONDS:-0}
      URL_DEDUPE_IN_PROGRESS_TTL_SECONDS: ${URL_DEDUPE_IN_PROGRESS_TTL_SECONDS:-0}
      URL_DEDUPE_SCOPE: ${URL_DEDUPE_SCOPE:-global}
      URL_DEDUPE_INDEX_PARTITION: ${URL_DEDUPE_INDEX_PARTITION:-urlidx}
      REDIS_URL_INDEX_PREFIX: ${REDIS_URL_INDEX_PREFIX:-urlidx:}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-10}
      MAX_DOWNLOAD_BYTES: ${MAX_DOWNLOAD_BYTES:-1048576}
      MAX_REDIRECTS: ${MAX_REDIRECTS:-5}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      ARTIFACT_DIR: /artifacts
      WEBPUBSUB_CONNECTION_STRING: ${WEBPUBSUB_CONNECTION_STRING:-}
      WEBPUBSUB_HUB: ${WEBPUBSUB_HUB:-scans}
      WEBPUBSUB_GROUP_PREFIX: ${WEBPUBSUB_GROUP_PREFIX:-run}
      WEBPUBSUB_USER_GROUP_PREFIX: ${WEBPUBSUB_USER_GROUP_PREFIX:-apikey}
    volumes:
      - artifacts:/artifacts
    depends_on:
      redis:
        condition: service_healthy
      artifacts-init:
        condition: service_completed_successfully

  worker:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    environment:
      LOG_FORMAT: ${LOG_FORMAT:-pretty}
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_TRACES_SAMPLER_RATIO: ${OTEL_TRACES_SAMPLER_RATIO:-0.10}
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-aca-urlscanner}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS:-}
      WORKER_MODE: analyzer
      QUEUE_NAME: ${SCAN_QUEUE_NAME:-tasks-scan}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_SCAN_QUEUE_KEY:-queue:tasks-scan}
      REDIS_DLQ_KEY: ${REDIS_DLQ_KEY:-dlq:tasks-scan}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      URL_DEDUPE_TTL_SECONDS: ${URL_DEDUPE_TTL_SECONDS:-0}
      URL_DEDUPE_IN_PROGRESS_TTL_SECONDS: ${URL_DEDUPE_IN_PROGRESS_TTL_SECONDS:-0}
      URL_DEDUPE_SCOPE: ${URL_DEDUPE_SCOPE:-global}
      URL_DEDUPE_INDEX_PARTITION: ${URL_DEDUPE_INDEX_PARTITION:-urlidx}
      REDIS_URL_INDEX_PREFIX: ${REDIS_URL_INDEX_PREFIX:-urlidx:}
      CAPTURE_SCREENSHOTS: ${CAPTURE_SCREENSHOTS:-false}
      SCREENSHOT_REDIS_PREFIX: ${SCREENSHOT_REDIS_PREFIX:-screenshot:}
      SCREENSHOT_CONTAINER: ${SCREENSHOT_CONTAINER:-screenshots}
      SCREENSHOT_FORMAT: ${SCREENSHOT_FORMAT:-jpeg}
      SCREENSHOT_TIMEOUT_SECONDS: ${SCREENSHOT_TIMEOUT_SECONDS:-12}
      SCREENSHOT_VIEWPORT_WIDTH: ${SCREENSHOT_VIEWPORT_WIDTH:-1280}
      SCREENSHOT_VIEWPORT_HEIGHT: ${SCREENSHOT_VIEWPORT_HEIGHT:-720}
      SCREENSHOT_FULL_PAGE: ${SCREENSHOT_FULL_PAGE:-false}
      SCREENSHOT_JPEG_QUALITY: ${SCREENSHOT_JPEG_QUALITY:-60}
      SCREENSHOT_SETTLE_MS: ${SCREENSHOT_SETTLE_MS:-750}
      SCREENSHOT_LOCALE: ${SCREENSHOT_LOCALE:-en-US}
      SCREENSHOT_USER_AGENT: ${SCREENSHOT_USER_AGENT:-}
      SCREENSHOT_TTL_SECONDS: ${SCREENSHOT_TTL_SECONDS:-0}
      MAX_RETRIES: ${MAX_RETRIES:-5}
      MAX_WAIT: ${MAX_WAIT:-5}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      WEB_WHOIS_TIMEOUT_SECONDS: ${WEB_WHOIS_TIMEOUT_SECONDS:-6.0}
      ARTIFACT_DIR: /artifacts
      ARTIFACT_DELETE_ON_SUCCESS: ${ARTIFACT_DELETE_ON_SUCCESS:-false}
      WEBPUBSUB_CONNECTION_STRING: ${WEBPUBSUB_CONNECTION_STRING:-}
      WEBPUBSUB_HUB: ${WEBPUBSUB_HUB:-scans}
      WEBPUBSUB_GROUP_PREFIX: ${WEBPUBSUB_GROUP_PREFIX:-run}
      WEBPUBSUB_USER_GROUP_PREFIX: ${WEBPUBSUB_USER_GROUP_PREFIX:-apikey}
    volumes:
      - artifacts:/artifacts
    depends_on:
      redis:
        condition: service_healthy
      artifacts-init:
        condition: service_completed_successfully

volumes:
  artifacts:
