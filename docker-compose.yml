services:
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  artifacts-init:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    user: "0"
    command: ["sh", "-c", "mkdir -p /artifacts && chmod 777 /artifacts"]
    volumes:
      - artifacts:/artifacts

  api:
    build:
      context: ./app
      dockerfile: api/Dockerfile
    ports:
      - "8000:8000"
    environment:
      PORT: "8000"
      QUEUE_NAME: ${QUEUE_NAME:-tasks}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_QUEUE_KEY:-queue:tasks}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      API_KEY: ${API_KEY:-local-dev-key}
      REQUIRE_API_KEY: ${REQUIRE_API_KEY:-true}
      API_KEY_HEADER: ${API_KEY_HEADER:-X-API-Key}
      RATE_LIMIT_RPM: ${RATE_LIMIT_RPM:-60}
      RATE_LIMIT_WINDOW_SECONDS: ${RATE_LIMIT_WINDOW_SECONDS:-60}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthz').read()
      interval: 10s
      timeout: 3s
      retries: 20

  fetcher:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    environment:
      WORKER_MODE: fetcher
      QUEUE_NAME: ${QUEUE_NAME:-tasks}
      SCAN_QUEUE_NAME: ${SCAN_QUEUE_NAME:-tasks-scan}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_QUEUE_KEY:-queue:tasks}
      REDIS_DLQ_KEY: ${REDIS_FETCHER_DLQ_KEY:-dlq:tasks}
      REDIS_SCAN_QUEUE_KEY: ${REDIS_SCAN_QUEUE_KEY:-queue:tasks-scan}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      SCAN_ENGINE: ${SCAN_ENGINE:-reputation,content}
      CONTENT_MAX_TEXT_BYTES: ${CONTENT_MAX_TEXT_BYTES:-200000}
      CONTENT_MAX_BASE64_MATCH: ${CONTENT_MAX_BASE64_MATCH:-50000}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-10}
      MAX_DOWNLOAD_BYTES: ${MAX_DOWNLOAD_BYTES:-1048576}
      MAX_REDIRECTS: ${MAX_REDIRECTS:-5}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      ARTIFACT_DIR: /artifacts
    volumes:
      - artifacts:/artifacts
    depends_on:
      redis:
        condition: service_healthy
      artifacts-init:
        condition: service_completed_successfully

  worker:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    environment:
      WORKER_MODE: analyzer
      QUEUE_NAME: ${SCAN_QUEUE_NAME:-tasks-scan}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_SCAN_QUEUE_KEY:-queue:tasks-scan}
      REDIS_DLQ_KEY: ${REDIS_DLQ_KEY:-dlq:tasks-scan}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      SCAN_ENGINE: ${SCAN_ENGINE:-reputation,content}
      CONTENT_MAX_TEXT_BYTES: ${CONTENT_MAX_TEXT_BYTES:-200000}
      CONTENT_MAX_BASE64_MATCH: ${CONTENT_MAX_BASE64_MATCH:-50000}
      REPUTATION_ALLOWLIST_HOSTS: ${REPUTATION_ALLOWLIST_HOSTS:-}
      REPUTATION_BLOCKLIST_HOSTS: ${REPUTATION_BLOCKLIST_HOSTS:-}
      REPUTATION_MIN_SCORE: ${REPUTATION_MIN_SCORE:-60}
      REPUTATION_BLOCK_ON_MALICIOUS: ${REPUTATION_BLOCK_ON_MALICIOUS:-false}
      REPUTATION_SUSPICIOUS_TLDS: ${REPUTATION_SUSPICIOUS_TLDS:-zip,top,xyz,click,icu,tk,gq,ml,cf,ga}
      REPUTATION_SUSPICIOUS_KEYWORDS: ${REPUTATION_SUSPICIOUS_KEYWORDS:-login,verify,update,secure,account,password,bank}
      ENABLE_DEMO_MARKERS: ${ENABLE_DEMO_MARKERS:-false}
      MAX_RETRIES: ${MAX_RETRIES:-5}
      MAX_WAIT: ${MAX_WAIT:-5}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      ARTIFACT_DIR: /artifacts
      ARTIFACT_DELETE_ON_SUCCESS: ${ARTIFACT_DELETE_ON_SUCCESS:-false}
    volumes:
      - artifacts:/artifacts
    depends_on:
      redis:
        condition: service_healthy
      artifacts-init:
        condition: service_completed_successfully

volumes:
  artifacts:
