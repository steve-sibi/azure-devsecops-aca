services:
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  artifacts-init:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    user: "0"
    command: ["sh", "-c", "mkdir -p /artifacts && chmod 777 /artifacts"]
    volumes:
      - artifacts:/artifacts

  clamav:
    build:
      context: ./app
      dockerfile: clamav/Dockerfile
    command:
      - sh
      - -c
      - freshclam --config-file=/etc/clamav/freshclam.conf && exec /usr/sbin/clamd --config-file=/etc/clamav/clamd.compose.conf

  api:
    build:
      context: ./app
      dockerfile: api/Dockerfile
    ports:
      - "8000:8000"
    environment:
      PORT: "8000"
      QUEUE_NAME: ${QUEUE_NAME:-tasks}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_QUEUE_KEY:-queue:tasks}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      API_KEY: ${API_KEY:-local-dev-key}
      REQUIRE_API_KEY: ${REQUIRE_API_KEY:-true}
      API_KEY_HEADER: ${API_KEY_HEADER:-X-API-Key}
      RATE_LIMIT_RPM: ${RATE_LIMIT_RPM:-60}
      RATE_LIMIT_WINDOW_SECONDS: ${RATE_LIMIT_WINDOW_SECONDS:-60}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      CLAMAV_HOST: ${CLAMAV_HOST:-clamav}
      CLAMAV_PORT: ${CLAMAV_PORT:-3310}
      CLAMAV_TIMEOUT_SECONDS: ${CLAMAV_TIMEOUT_SECONDS:-8}
      FILE_SCAN_MAX_BYTES: ${FILE_SCAN_MAX_BYTES:-10485760}
      FILE_SCAN_INCLUDE_VERSION: ${FILE_SCAN_INCLUDE_VERSION:-true}
    depends_on:
      redis:
        condition: service_healthy
      clamav:
        condition: service_started
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthz').read()
      interval: 10s
      timeout: 3s
      retries: 20

  fetcher:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    environment:
      WORKER_MODE: fetcher
      QUEUE_NAME: ${QUEUE_NAME:-tasks}
      SCAN_QUEUE_NAME: ${SCAN_QUEUE_NAME:-tasks-scan}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_QUEUE_KEY:-queue:tasks}
      REDIS_DLQ_KEY: ${REDIS_FETCHER_DLQ_KEY:-dlq:tasks}
      REDIS_SCAN_QUEUE_KEY: ${REDIS_SCAN_QUEUE_KEY:-queue:tasks-scan}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-10}
      MAX_DOWNLOAD_BYTES: ${MAX_DOWNLOAD_BYTES:-1048576}
      MAX_REDIRECTS: ${MAX_REDIRECTS:-5}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      ARTIFACT_DIR: /artifacts
    volumes:
      - artifacts:/artifacts
    depends_on:
      redis:
        condition: service_healthy
      artifacts-init:
        condition: service_completed_successfully

  worker:
    build:
      context: ./app
      dockerfile: worker/Dockerfile.sidecar
    environment:
      WORKER_MODE: analyzer
      QUEUE_NAME: ${SCAN_QUEUE_NAME:-tasks-scan}
      QUEUE_BACKEND: ${QUEUE_BACKEND:-redis}
      RESULT_BACKEND: ${RESULT_BACKEND:-redis}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_QUEUE_KEY: ${REDIS_SCAN_QUEUE_KEY:-queue:tasks-scan}
      REDIS_DLQ_KEY: ${REDIS_DLQ_KEY:-dlq:tasks-scan}
      REDIS_RESULT_PREFIX: ${REDIS_RESULT_PREFIX:-scan:}
      REDIS_RESULT_TTL_SECONDS: ${REDIS_RESULT_TTL_SECONDS:-0}
      MAX_RETRIES: ${MAX_RETRIES:-5}
      MAX_WAIT: ${MAX_WAIT:-5}
      BLOCK_PRIVATE_NETWORKS: ${BLOCK_PRIVATE_NETWORKS:-true}
      ARTIFACT_DIR: /artifacts
      ARTIFACT_DELETE_ON_SUCCESS: ${ARTIFACT_DELETE_ON_SUCCESS:-false}
    volumes:
      - artifacts:/artifacts
    depends_on:
      redis:
        condition: service_healthy
      artifacts-init:
        condition: service_completed_successfully

volumes:
  artifacts:
