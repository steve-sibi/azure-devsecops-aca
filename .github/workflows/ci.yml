name: CI
on:
  pull_request:
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  push:
    branches: [ main ]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  python-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      LOG_DIR: .ci-logs
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with: { python-version: "3.11" }

      - name: Prepare logs
        run: mkdir -p "$LOG_DIR"

      - name: Install ruff + pytest
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff pytest beautifulsoup4 adblockparser tldextract yara-python \
            azure-servicebus azure-identity azure-data-tables azure-storage-blob azure-core

      - name: Ruff (syntax/undefined names)
        id: ruff
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          ruff check . --select E9,F63,F7,F82 2>&1 | tee "$LOG_DIR/ruff.log"

      - name: Python compile check
        id: py_compile
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          python -m compileall app scripts .github 2>&1 | tee "$LOG_DIR/compile.log"

      - name: Pytest
        id: pytest
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          pytest 2>&1 | tee "$LOG_DIR/pytest.log"

      - name: Job summary (python-quality)
        if: ${{ always() }}
        shell: bash
        run: |
          {
            echo "## Python quality"
            echo ""
            echo "| Check | Result |"
            echo "|---|---|"
            echo "| Ruff | ${{ steps.ruff.outcome }} |"
            echo "| Compile | ${{ steps.py_compile.outcome }} |"
            echo "| Pytest | ${{ steps.pytest.outcome }} |"
            echo ""

            echo "### Recommended fixes"
            ruff_outcome="${{ steps.ruff.outcome }}"
            compile_outcome="${{ steps.py_compile.outcome }}"
            pytest_outcome="${{ steps.pytest.outcome }}"

            if [ "$ruff_outcome" != "success" ]; then
              echo "- Run \`ruff check . --fix\` for safe autofixes (then \`ruff format\` if enabled)."
            fi
            if [ "$compile_outcome" != "success" ]; then
              echo "- Fix Python syntax errors (see \`compile.log\`)."
            fi
            if [ "$pytest_outcome" != "success" ]; then
              echo "- Re-run \`pytest -q\` locally and fix failing tests."
            fi
            if [ "$ruff_outcome$compile_outcome$pytest_outcome" = "successsuccesssuccess" ]; then
              echo "- No action needed."
            fi
            echo ""

            for f in ruff.log compile.log pytest.log; do
              p="$LOG_DIR/$f"
              if [ -f "$p" ]; then
                echo "<details><summary>$f</summary>"
                echo ""
                echo '```text'
                tail -n 200 "$p"
                echo '```'
                echo "</details>"
                echo ""
              fi
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs (python-quality)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-python-quality
          path: ${{ env.LOG_DIR }}
          if-no-files-found: ignore

      - name: Fail if quality checks failed
        if: ${{ always() }}
        shell: bash
        run: |
          if [ "${{ steps.ruff.outcome }}" != "success" ] || \
             [ "${{ steps.py_compile.outcome }}" != "success" ] || \
             [ "${{ steps.pytest.outcome }}" != "success" ]; then
            exit 1
          fi

  iac-and-docker-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    env:
      LOG_DIR: .ci-logs
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with: { python-version: "3.11" }

      - uses: hashicorp/setup-terraform@v3

      - name: Prepare logs
        run: mkdir -p "$LOG_DIR"

      - name: Terraform fmt (check)
        id: terraform_fmt
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          terraform fmt -check -recursive infra 2>&1 | tee "$LOG_DIR/terraform-fmt.log"

      - name: Terraform init (backend disabled)
        id: terraform_init
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          terraform -chdir=infra init -backend=false 2>&1 | tee "$LOG_DIR/terraform-init.log"

      - name: Terraform validate
        id: terraform_validate
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          terraform -chdir=infra validate -no-color 2>&1 | tee "$LOG_DIR/terraform-validate.log"

      - name: Install Checkov
        run: pip install checkov

      - name: Checkov (Terraform → SARIF)
        id: checkov
        run: |
          set -euo pipefail
          checkov -d infra --framework terraform --config-file checkov.yml --skip-download --quiet -o sarif --output-file checkov.sarif 2>&1 | tee "$LOG_DIR/checkov.log" || true

      - name: Prepare Checkov SARIF
        id: checkov_sarif
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail

          sarif_file=""

          if [ -f "checkov.sarif" ]; then
            sarif_file="checkov.sarif"
          elif [ -d "checkov.sarif" ]; then
            sarif_file="$(find checkov.sarif -type f -name '*.sarif' | head -n 1 || true)"
          elif [ -f "results_sarif.sarif" ]; then
            sarif_file="results_sarif.sarif"
          fi

          if [ -n "$sarif_file" ] && [ -s "$sarif_file" ]; then
            cp "$sarif_file" "checkov-results.sarif"
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "sarif_file=checkov-results.sarif" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::warning::Checkov did not create a SARIF file."
          echo "found=false" >> "$GITHUB_OUTPUT"
          echo "sarif_file=" >> "$GITHUB_OUTPUT"

      - name: Upload Checkov SARIF
        if: >-
          ${{ always()
            && steps.checkov_sarif.outputs.found == 'true'
            && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.checkov_sarif.outputs.sarif_file }}
          category: checkov-terraform

      - name: Hadolint (API)
        id: hadolint_api
        continue-on-error: true
        uses: hadolint/hadolint-action@v3
        with:
          dockerfile: app/api/Dockerfile

      - name: Hadolint (Worker)
        id: hadolint_worker
        continue-on-error: true
        uses: hadolint/hadolint-action@v3
        with:
          dockerfile: app/worker/Dockerfile.sidecar

      - name: Hadolint (ClamAV)
        id: hadolint_clamav
        continue-on-error: true
        uses: hadolint/hadolint-action@v3
        with:
          dockerfile: app/clamav/Dockerfile

      - name: Job summary (iac-and-docker-lint)
        if: ${{ always() }}
        shell: bash
        run: |
          {
            echo "## IaC & Docker lint"
            echo ""
            echo "| Check | Result |"
            echo "|---|---|"
            echo "| Terraform fmt | ${{ steps.terraform_fmt.outcome }} |"
            echo "| Terraform init | ${{ steps.terraform_init.outcome }} |"
            echo "| Terraform validate | ${{ steps.terraform_validate.outcome }} |"
            echo "| Checkov | ${{ steps.checkov.outcome }} |"
            echo "| Hadolint (API) | ${{ steps.hadolint_api.outcome }} |"
            echo "| Hadolint (Worker) | ${{ steps.hadolint_worker.outcome }} |"
            echo "| Hadolint (ClamAV) | ${{ steps.hadolint_clamav.outcome }} |"
            echo ""

            tf_validate_log="$LOG_DIR/terraform-validate.log"
            if [ -f "$tf_validate_log" ]; then
              warn_count="$(grep -c '^Warning:' "$tf_validate_log" || true)"
              err_count="$(grep -c '^Error:' "$tf_validate_log" || true)"
              echo "### Terraform diagnostics"
              echo "- Warnings: $warn_count"
              echo "- Errors: $err_count"

              deprecated_lines="$(grep -n 'deprecated' "$tf_validate_log" | head -n 20 || true)"
              if [ -n "$deprecated_lines" ]; then
                echo ""
                echo "<details><summary>Terraform deprecations (first 20 matches)</summary>"
                echo ""
                echo '```text'
                printf '%s\n' "$deprecated_lines"
                echo '```'
                echo "</details>"
              fi
              echo ""
            fi

            echo "### Checkov findings"
            checkov_sarif="${{ steps.checkov_sarif.outputs.sarif_file }}"
            if [ -n "$checkov_sarif" ] && [ -f "$checkov_sarif" ]; then
              SARIF_FILE="$checkov_sarif" python - <<'PY'
          import json
          import os
          from pathlib import Path

          sarif = Path(os.environ["SARIF_FILE"])
          data = json.loads(sarif.read_text(encoding="utf-8"))
          runs = data.get("runs") or []
          results = (runs[0].get("results") if runs else []) or []
          print(f"- Results: {len(results)}")
          PY
            else
              echo "- SARIF output not found"
            fi
            echo ""

            echo "### Recommended fixes"
            if [ "${{ steps.terraform_fmt.outcome }}" != "success" ]; then
              echo "- Run \`terraform fmt -recursive infra\` (then re-run CI)."
            fi
            if [ "${{ steps.terraform_validate.outcome }}" != "success" ]; then
              echo "- Run \`terraform -chdir=infra init -backend=false\` then \`terraform -chdir=infra validate\` locally."
            fi
            if [ "${{ steps.hadolint_api.outcome }}" != "success" ] || \
               [ "${{ steps.hadolint_worker.outcome }}" != "success" ] || \
               [ "${{ steps.hadolint_clamav.outcome }}" != "success" ]; then
              echo "- Fix Dockerfile lint violations (see Hadolint step logs)."
            fi
            echo ""

            for f in terraform-fmt.log terraform-init.log terraform-validate.log checkov.log; do
              p="$LOG_DIR/$f"
              if [ -f "$p" ]; then
                echo "<details><summary>$f</summary>"
                echo ""
                echo '```text'
                tail -n 200 "$p"
                echo '```'
                echo "</details>"
                echo ""
              fi
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs (iac-and-docker-lint)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-iac-and-docker-lint
          path: |
            ${{ env.LOG_DIR }}
            checkov-results.sarif
          if-no-files-found: ignore

      - name: Fail if required checks failed
        if: ${{ always() }}
        shell: bash
        run: |
          if [ "${{ steps.terraform_fmt.outcome }}" != "success" ] || \
             [ "${{ steps.terraform_init.outcome }}" != "success" ] || \
             [ "${{ steps.terraform_validate.outcome }}" != "success" ] || \
             [ "${{ steps.hadolint_api.outcome }}" != "success" ] || \
             [ "${{ steps.hadolint_worker.outcome }}" != "success" ] || \
             [ "${{ steps.hadolint_clamav.outcome }}" != "success" ]; then
            exit 1
          fi

  build-and-scan:
    needs: [python-quality, iac-and-docker-lint]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    env:
      LOG_DIR: .ci-logs
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: api
            dockerfile: app/api/Dockerfile
          - name: worker
            dockerfile: app/worker/Dockerfile.sidecar
          - name: clamav
            dockerfile: app/clamav/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.name }} (cache)
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: ./${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: false
          load: true # load into local Docker so Trivy can scan
          tags: ${{ matrix.name }}:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Trivy scan ${{ matrix.name }} image → SARIF
        id: trivy_scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ matrix.name }}:ci
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          format: sarif
          # Use a workspace-relative path (the Trivy action runs in a container, so host-absolute
          # paths like ${{ github.workspace }} may not be writable/visible).
          output: trivy-${{ matrix.name }}.sarif
          exit-code: '0' # keep pipeline green; review SARIF for issues
      - name: Prepare Trivy SARIF (${{ matrix.name }})
        id: trivy_sarif
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          sarif_file="$GITHUB_WORKSPACE/trivy-${{ matrix.name }}.sarif"
          scan_outcome="${{ steps.trivy_scan.outcome }}"

          if [ -s "$sarif_file" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "sarif_file=$sarif_file" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::warning::Trivy did not create $sarif_file (scan_outcome=$scan_outcome)."

          if [ "$scan_outcome" = "success" ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"Trivy"}},"results":[]}]}' > "$sarif_file"
            echo "::notice::Created an empty SARIF so GitHub code scanning stays in sync."
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "sarif_file=$sarif_file" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "found=false" >> "$GITHUB_OUTPUT"
          echo "sarif_file=" >> "$GITHUB_OUTPUT"
      - name: Upload Trivy SARIF (${{ matrix.name }})
        if: >-
          ${{ always()
            && steps.trivy_sarif.outputs.found == 'true'
            && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.trivy_sarif.outputs.sarif_file }}
          category: trivy-${{ matrix.name }}

      - name: Prepare logs
        if: ${{ always() }}
        run: mkdir -p "$LOG_DIR"

      - name: Job summary (build-and-scan)
        if: ${{ always() }}
        shell: bash
        run: |
          {
            echo "## Build & scan (${{ matrix.name }})"
            echo ""
            echo "| Step | Result |"
            echo "|---|---|"
            echo "| Docker build | ${{ steps.docker_build.outcome }} |"
            echo "| Trivy scan | ${{ steps.trivy_scan.outcome }} |"
            echo ""

            sarif_file="trivy-${{ matrix.name }}.sarif"
            if [ -f "$sarif_file" ]; then
              echo "### Trivy findings"
              python3 - <<PY
          import json
          from pathlib import Path

          sarif = Path("$sarif_file")
          data = json.loads(sarif.read_text(encoding="utf-8"))
          runs = data.get("runs") or []
          results = (runs[0].get("results") if runs else []) or []
          by_level = {}
          for r in results:
            level = r.get("level") or "unknown"
            by_level[level] = by_level.get(level, 0) + 1

          total = len(results)
          print(f"- Results: {total}")
          for level, count in sorted(by_level.items()):
            print(f"- {level}: {count}")
          PY
              echo ""
            fi

            echo "### Recommended fixes"
            echo "- Review GitHub Code Scanning results for details (Trivy SARIF upload)."
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs (build-and-scan)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-build-and-scan-${{ matrix.name }}
          path: |
            ${{ env.LOG_DIR }}
            trivy-${{ matrix.name }}.sarif
          if-no-files-found: ignore
