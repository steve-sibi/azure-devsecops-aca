name: KEDA Scale Test
on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: Resource group name (e.g. rg-devsecops-aca)
        required: true
        default: rg-devsecops-aca
      prefix:
        description: Resource prefix (e.g. devsecopsaca)
        required: true
        default: devsecopsaca
      queue_name:
        description: Service Bus queue name
        required: true
        default: tasks
      scan_url:
        description: Public HTTPS URL to scan (must be <= 1MB)
        required: true
        default: https://example.com
      message_count:
        description: Number of messages to enqueue
        required: true
        default: "100"
      expected_min_replicas:
        description: Minimum worker replicas to observe
        required: true
        default: "1"
      timeout_seconds:
        description: Timeout waiting for scale-out
        required: true
        default: "600"

concurrency:
  # Prevent deploy/destroy/keda runs from overlapping for the same environment
  group: aca-${{ inputs.prefix }}-${{ inputs.resource_group }}
  cancel-in-progress: false

jobs:
  keda-scale-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions: { id-token: write, contents: read }
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Azure Login (OIDC)
        uses: azure/login@1384c340ab2dda50fed2bee3041d1d87018aa5e8 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with: { python-version: "3.11" }

      - name: Install deps (enqueue script)
        run: |
          python -m pip install --upgrade pip
          python -m pip install "azure-servicebus~=7.12"

      - name: Run KEDA scale test
        shell: bash
        run: |
          bash scripts/keda_scale_test.sh \
            --resource-group "${{ inputs.resource_group }}" \
            --prefix "${{ inputs.prefix }}" \
            --queue-name "${{ inputs.queue_name }}" \
            --message-count "${{ inputs.message_count }}" \
            --expected-min-replicas "${{ inputs.expected_min_replicas }}" \
            --scan-url "${{ inputs.scan_url }}" \
            --timeout-seconds "${{ inputs.timeout_seconds }}"

      - name: Write workflow summary
        if: always()
        shell: bash
        run: |
          esc_cell() {
            # Keep markdown tables safe: escape pipes and newlines.
            printf '%s' "$1" | tr '\n' ' ' | sed 's/|/\\\\|/g'
          }

          {
            echo "## KEDA Scale Test Summary"
            echo ""
            echo "| Parameter | Value |"
            echo "|-----------|-------|"
            echo "| **Resource Group** | \`$(esc_cell \"${{ inputs.resource_group }}\")\` |"
            echo "| **Queue** | \`$(esc_cell \"${{ inputs.queue_name }}\")\` |"
            echo "| **Messages Sent** | \`$(esc_cell \"${{ inputs.message_count }}\")\` |"
            echo "| **Expected Min Replicas** | \`$(esc_cell \"${{ inputs.expected_min_replicas }}\")\` |"
            echo "| **Scan URL** | \`$(esc_cell \"${{ inputs.scan_url }}\")\` |"
          } >> "$GITHUB_STEP_SUMMARY"
