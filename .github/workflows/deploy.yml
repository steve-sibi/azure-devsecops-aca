name: Deploy
on:
  workflow_dispatch:
    inputs:
      mode:
        description: Deployment mode (full or infra-only)
        required: true
        default: full
      region:
        description: Azure region (e.g. eastus)
        required: true
        default: eastus
      prefix:
        description: Resource prefix (lowercase; used for most resource names)
        required: true
        default: devsecopsaca
      resource_group:
        description: Resource group name (e.g. rg-devsecops-aca)
        required: true
        default: rg-devsecops-aca
      tfstate_sa:
        description: Terraform state storage account name (globally unique; lowercase letters/numbers only)
        required: true
        default: stdevsecopsacatfstate
      tfstate_container:
        description: Terraform state container name
        required: true
        default: tfstate
      tfstate_key:
        description: Terraform state blob name
        required: true
        default: devsecopsaca.tfstate
      queue_name:
        description: Service Bus queue name
        required: true
        default: tasks
      scan_queue_name:
        description: Optional scan queue name (defaults to <queue_name>-scan)
        required: false
        default: ""
      apply_requires_approval:
        description: Require GitHub Environment approval before infra apply (true/false)
        required: false
        default: "false"

concurrency:
  # Prevent deploy/destroy/keda runs from overlapping for the same environment
  group: aca-${{ inputs.prefix }}-${{ inputs.resource_group }}
  # If an App Deploy (CD) run is already in progress for this environment, cancel it so infra deploy can proceed.
  cancel-in-progress: true

# NOTE: Keep shared inputs in sync with destroy.yml to avoid configuration drift.
# (mode/apply_requires_approval are deploy-only)
env:
  MODE: ${{ inputs.mode }}
  REGION: ${{ inputs.region }}
  PREFIX: ${{ inputs.prefix }}
  RG: ${{ inputs.resource_group }}
  TFSTATE_SA: ${{ inputs.tfstate_sa }}
  TFSTATE_CONTAINER: ${{ inputs.tfstate_container }}
  TFSTATE_KEY: ${{ inputs.tfstate_key }}
  QUEUE_NAME: ${{ inputs.queue_name }}
  SCAN_QUEUE_NAME: ${{ inputs.scan_queue_name }}
  APPLY_REQUIRES_APPROVAL: ${{ inputs.apply_requires_approval }}
  KV_SECRET_READER_OBJECT_IDS_JSON: ${{ vars.ACA_KV_SECRET_READER_OBJECT_IDS_JSON || '' }}
  MONITOR_ACTION_GROUP_EMAIL_RECEIVERS_JSON: ${{ vars.ACA_MONITOR_ACTION_GROUP_EMAIL_RECEIVERS_JSON || '' }}
  MONITOR_ALERTS_ENABLED: ${{ vars.ACA_MONITOR_ALERTS_ENABLED || '' }}
  MONITOR_WORKBOOK_ENABLED: ${{ vars.ACA_MONITOR_WORKBOOK_ENABLED || '' }}
  E2E_SCAN_URL: ${{ vars.ACA_E2E_SCAN_URL || '' }}
  OBS_VERIFY_ATTEMPTS: ${{ vars.ACA_OBS_VERIFY_ATTEMPTS || '' }}
  OBS_VERIFY_SLEEP_SECONDS: ${{ vars.ACA_OBS_VERIFY_SLEEP_SECONDS || '' }}
  OBS_VERIFY_LOOKBACK_MINUTES: ${{ vars.ACA_OBS_VERIFY_LOOKBACK_MINUTES || '' }}
  OTEL_TRACES_SAMPLER_RATIO: ${{ vars.ACA_OTEL_TRACES_SAMPLER_RATIO || '1.0' }}
  OBS_VERIFY_REQUIRE_TRACE: ${{ vars.ACA_OBS_VERIFY_REQUIRE_TRACE || 'true' }}

jobs:
  infra-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions: { id-token: write, contents: read }

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3

      - name: Cache Terraform plugins
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ${{ runner.temp }}/.terraform-plugin-cache
          key: terraform-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Bootstrap + plan infra
        shell: bash
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform-plugin-cache
          TERRAFORM_OPERATION: plan
          TF_PLAN_FILE: infra.tfplan
          TF_PLAN_TEXT_FILE: infra-plan.txt
        run: |
          mkdir -p "$TF_PLUGIN_CACHE_DIR"
          bash scripts/gha/deploy_infra_bootstrap.sh

      - name: Upload Terraform plan artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: infra-plan-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            infra/infra.tfplan
            infra/infra-plan.txt
          if-no-files-found: error
          retention-days: 7

      - name: Write infra-plan summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Infra plan"
            echo ""
            if [ -f "infra/infra-plan.txt" ]; then
              echo "<details><summary>Terraform plan (first 200 lines)</summary>"
              echo ""
              echo '```text'
              sed -n '1,200p' infra/infra-plan.txt
              echo '```'
              echo "</details>"
            else
              echo "- Plan output not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  infra-apply-auto:
    needs: [infra-plan]
    if: >-
      ${{ !(inputs.apply_requires_approval == 'true'
        || inputs.apply_requires_approval == '1'
        || inputs.apply_requires_approval == 'yes'
        || inputs.apply_requires_approval == 'TRUE'
        || inputs.apply_requires_approval == 'YES') }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions: { id-token: write, contents: read }

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download Terraform plan artifacts
        uses: actions/download-artifact@v5
        with:
          name: infra-plan-${{ github.run_id }}-${{ github.run_attempt }}
          path: infra

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3

      - name: Cache Terraform plugins
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ${{ runner.temp }}/.terraform-plugin-cache
          key: terraform-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Apply infra plan
        shell: bash
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform-plugin-cache
          TERRAFORM_OPERATION: apply
          TF_PLAN_FILE: infra.tfplan
        run: |
          mkdir -p "$TF_PLUGIN_CACHE_DIR"
          bash scripts/gha/deploy_infra_bootstrap.sh

      - name: Write infra-apply summary
        if: always()
        shell: bash
        run: |
          python3 .github/scripts/deploy_summary.py infra-bootstrap

  infra-apply-approved:
    needs: [infra-plan]
    if: >-
      ${{ inputs.apply_requires_approval == 'true'
        || inputs.apply_requires_approval == '1'
        || inputs.apply_requires_approval == 'yes'
        || inputs.apply_requires_approval == 'TRUE'
        || inputs.apply_requires_approval == 'YES' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions: { id-token: write, contents: read }
    environment: aca-apply-approval

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download Terraform plan artifacts
        uses: actions/download-artifact@v5
        with:
          name: infra-plan-${{ github.run_id }}-${{ github.run_attempt }}
          path: infra

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3

      - name: Cache Terraform plugins
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ${{ runner.temp }}/.terraform-plugin-cache
          key: terraform-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Apply infra plan (approved)
        shell: bash
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform-plugin-cache
          TERRAFORM_OPERATION: apply
          TF_PLAN_FILE: infra.tfplan
        run: |
          mkdir -p "$TF_PLUGIN_CACHE_DIR"
          bash scripts/gha/deploy_infra_bootstrap.sh

      - name: Write infra-apply summary
        if: always()
        shell: bash
        run: |
          python3 .github/scripts/deploy_summary.py infra-bootstrap

  build-and-push:
    needs: [infra-apply-auto, infra-apply-approved]
    if: >-
      ${{ always()
        && inputs.mode != 'infra-only'
        && (needs.infra-apply-auto.result == 'success' || needs.infra-apply-approved.result == 'success') }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions: { id-token: write, contents: read }

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR login server
        id: acr
        run: |
          ACR="$(az acr show -g "${{ env.RG }}" -n "${{ env.PREFIX }}acr" --query loginServer -o tsv)"
          echo "login_server=${ACR}" >> "${GITHUB_OUTPUT}"

      - name: ACR login
        run: |
          ACR_NAME="$(echo "${{ steps.acr.outputs.login_server }}" | cut -d. -f1)"
          az acr login --name "${ACR_NAME}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build & push API
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: ./app
          file: app/api/Dockerfile
          pull: true
          push: true
          tags: ${{ steps.acr.outputs.login_server }}/${{ env.PREFIX }}-api:${{ github.sha }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api,ignore-error=true

      - name: Build & push Worker
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: ./app
          file: app/worker/Dockerfile.sidecar
          pull: true
          push: true
          tags: ${{ steps.acr.outputs.login_server }}/${{ env.PREFIX }}-worker:${{ github.sha }}
          cache-from: type=gha,scope=worker
          cache-to: type=gha,mode=max,scope=worker,ignore-error=true

      - name: Build & push ClamAV
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: ./app
          file: app/clamav/Dockerfile
          pull: true
          push: true
          tags: ${{ steps.acr.outputs.login_server }}/${{ env.PREFIX }}-clamav:${{ github.sha }}
          cache-from: type=gha,scope=clamav
          cache-to: type=gha,mode=max,scope=clamav,ignore-error=true

      - name: Write build-push summary
        if: always()
        shell: bash
        env:
          ACR_LOGIN_SERVER: ${{ steps.acr.outputs.login_server }}
          API_IMAGE: ${{ steps.acr.outputs.login_server }}/${{ env.PREFIX }}-api:${{ github.sha }}
          WORKER_IMAGE: ${{ steps.acr.outputs.login_server }}/${{ env.PREFIX }}-worker:${{ github.sha }}
          CLAMAV_IMAGE: ${{ steps.acr.outputs.login_server }}/${{ env.PREFIX }}-clamav:${{ github.sha }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          python3 .github/scripts/deploy_summary.py build-push

  create-apps:
    needs: [build-and-push]
    if: ${{ inputs.mode != 'infra-only' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions: { id-token: write, contents: read }

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3

      - name: Cache Terraform plugins
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ${{ runner.temp }}/.terraform-plugin-cache
          key: terraform-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Create/update apps + smoke/e2e tests
        shell: bash
        env:
          IMAGE_TAG: ${{ github.sha }}
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform-plugin-cache
        run: |
          mkdir -p "$TF_PLUGIN_CACHE_DIR"
          bash scripts/gha/deploy_create_apps_and_test.sh | tee deploy_output.log

      - name: Collect deploy runtime context
        if: always()
        shell: bash
        env:
          DEPLOY_LOG_FILE: deploy_output.log
          DEPLOY_CONTEXT_OUTPUT_FILE: deploy_runtime_context.env
        run: |
          bash scripts/gha/collect_deploy_runtime_context.sh

      - name: Verify observability ingestion
        id: verify_observability
        if: always()
        continue-on-error: ${{ !(env.OBS_VERIFY_REQUIRE_TRACE == 'true' || env.OBS_VERIFY_REQUIRE_TRACE == '1' || env.OBS_VERIFY_REQUIRE_TRACE == 'yes' || env.OBS_VERIFY_REQUIRE_TRACE == 'TRUE' || env.OBS_VERIFY_REQUIRE_TRACE == 'YES') }}
        shell: bash
        env:
          OBS_VERIFY_REQUIRE_TRACE: ${{ env.OBS_VERIFY_REQUIRE_TRACE }}
        run: |
          chmod +x scripts/gha/verify_observability.sh
          bash scripts/gha/verify_observability.sh

      - name: Capture observability check status
        if: always()
        shell: bash
        run: |
          echo "OBSERVABILITY_STATUS=${{ steps.verify_observability.outcome }}" >> "$GITHUB_ENV"

      - name: Upload deploy diagnostics
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: deploy-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            deploy_output.log
            deploy_runtime_context.env
          if-no-files-found: ignore
          retention-days: 14

      - name: Write workflow summary
        if: always()
        shell: bash
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          python3 .github/scripts/deploy_summary.py create-apps
